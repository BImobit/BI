<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ADM - EXTRUTURADOR DE FATURAS DE ENERGIA</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/LOGO_PeD.png">

  <!-- pdf.js via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- ExcelJS para gerar XLSX com TABELA de verdade -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <!-- PDF-LIB (mesclar PDFs) -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      background: #111827;
      color: #e5e7eb;
      margin: 0;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 8px;
      text-align: left;
    }

    /* HEADER FORA DO CARD (logo + suporte) */
    .top-header {
      position: relative;
      max-width: 900px;
      margin: 16px auto 0;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .header-logo-container {
      text-align: center;
      margin-bottom: 4px;
    }

    .header-logo {
      max-width: 220px;
      width: 100%;
      height: auto;
      object-fit: contain;
    }

    .support-info {
      right: 20px;
      font-size: 11px;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      text-align: right;
    }

    .support-info span strong {
      color: #e5e7eb;
    }

    .card {
      background: #1f2937;
      border-radius: 10px;
      padding: 16px 20px 18px 20px;
      max-width: 900px;
      margin: 10px auto 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      border: 1px solid #374151;
    }

    button {
      margin-top: 4px;
      margin-right: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #3b82f6;
      color: white;
      font-weight: 500;
      font-size: 13px;
    }

    button.secondary {
      background: #374151;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
      min-height: 16px;
    }

    #result {
      margin-top: 12px;
      display: none;
    }

    /* Hints de passo a passo */
    .step-hint {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .step-bullet {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .step-arrow {
      font-size: 12px;
      opacity: 0.9;
    }

    /* Seletor de tipo de fatura (com logo) */
    .tipo-fatura {
      margin-top: 10px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #d1d5db;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    .tipo-fatura span strong {
      font-size: 12px;
      color: #e5e7eb;
    }

    .tipo-option {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease-in-out;
    }

    .tipo-option input[type="radio"] {
      accent-color: #3b82f6;
      cursor: pointer;
    }

    .tipo-option-content {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tipo-option-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
      filter: brightness(1.05);
    }

    /* Layout da √°rea de resultado (2 blocos lado a lado) */
    .result-layout {
      display: flex;
      gap: 16px;
      align-items: stretch;
      margin-top: 8px;
    }

    .main-output {
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .main-output > .step-hint {
      margin-top: 0;
      margin-bottom: 6px;
    }

    /* Painel de sucesso */
    .success-panel {
      position: relative;
      flex: 1 1 auto;
      padding: 16px 16px 18px 16px;
      border-radius: 12px;
      border: 1px solid #374151;
      background: radial-gradient(circle at top left, #1d4ed8 0%, #020617 45%, #020617 100%);
      box-shadow: 0 8px 24px rgba(15,23,42,0.7);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .success-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .success-badge {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle, #22c55e 0%, #15803d 45%, #052e16 100%);
      box-shadow: 0 0 0 0 rgba(34,197,94,0.7);
      animation: pulse 1.8s infinite;
      font-size: 16px;
    }

    .success-title {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .success-sub {
      font-size: 12px;
      color: #cbd5f5;
    }

    .success-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.7); }
      70% { box-shadow: 0 0 0 12px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }

    /* ===== Bot√µes bonitos ===== */
    .action-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }

    .action-btn{
      margin:0;
      padding:10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(90deg, #374151, #111827);
      color:#e5e7eb;
      font-weight:700;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.28);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }

    .action-btn:hover{
      filter: brightness(1.15);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.34);
    }

    .action-btn:active{
      transform: scale(0.98);
    }

    .action-btn.primary{
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      border: 1px solid rgba(59,130,246,0.35);
    }

    .action-btn.danger{
      background: linear-gradient(90deg, #991b1b, #ef4444);
      border: 1px solid rgba(239,68,68,0.35);
    }

    .action-icon{
      width:28px;
      height:28px;
      border-radius:10px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex-shrink:0;
    }

    .action-icon img{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: brightness(1.05);
    }

    /* ===== Bot√µes de download com gradientes tem√°ticos ===== */
    .download-button {
      margin-top: 4px;
      margin-right: 0;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      min-width: 0;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 10px 22px rgba(0,0,0,0.28);
      transition: transform .12s ease, filter .12s ease;
    }

    .download-icon {
      width: 30px;
      height: 30px;
      object-fit: contain;
      filter: brightness(1.05);
    }

    .download-button:hover {
      filter: brightness(1.10);
      transform: translateY(-1px);
    }

    .download-button:active {
      transform: scale(0.98);
    }

    /* Excel vibe */
    .download-excel{
      background: linear-gradient(90deg, #0f7b3d, #22c55e);
      border-color: rgba(34,197,94,0.40);
    }

    /* PDF vibe */
    .download-pdf{
      background: linear-gradient(90deg, #b91c1c, #ef4444);
      border-color: rgba(239,68,68,0.40);
    }

    .download-tip {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* Caixa lateral */
    .side-buttons {
      flex: 0 0 260px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #0b0f19;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 14px;
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.4);
    }

    .side-title {
      font-size: 14px;
      font-weight: 700;
      color: #e5e7eb;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .side-desc {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .side-separator {
      border: 0;
      border-top: 1px dashed #1f2937;
      margin: 8px 0;
    }

    /* Bloco da logo da concession√°ria */
    .dist-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 10px;
      background: #020617;
      border: 1px dashed #1f2937;
    }

    .dist-logo-wrapper {
      width: 90px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dist-logo {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      filter: brightness(1.05);
    }

    .dist-label {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }

    /* Bot√µes laterais chamativos */
    .side-button {
      position: relative;
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      cursor: pointer;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      transition: all 0.15s ease-in-out;
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.35);
      text-align: center;
      margin: 0;
    }

    .side-button:hover {
      filter: brightness(1.2);
      transform: translateY(-1px);
    }

    .side-button:active {
      transform: scale(0.96);
    }

    /* Bot√£o do painel com logo do Power BI */
    .panel-button {
      position: relative;
      padding-right: 46px;
      padding-left: 12px;
      background: linear-gradient(90deg, #f2c811, #f59e0b);
      box-shadow: 0 4px 16px rgba(242, 200, 17, 0.45);
      color: #111827;
    }

    .panel-logo {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      object-fit: contain;
      pointer-events: none;
      filter: brightness(1.05);
    }

    /* Tela de loading global */
    #loader {
      position: fixed;
      inset: 0;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
    }

    #loader-logo {
      width: 200px;
      max-width: 60vw;
      margin-bottom: 12px;
    }

    .loader-text {
      color: #e5e7eb;
      font-size: 14px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .loader-bar {
      margin-top: 12px;
      width: 180px;
      max-width: 70vw;
      height: 4px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .loader-bar-inner {
      width: 40%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #1d4ed8, #38bdf8, #22c55e);
      animation: load 1.2s infinite;
    }

    @keyframes load {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(250%); }
    }

    /* Loader local na √°rea do resultado */
    .result-loader {
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      height: 160px;
      border-radius: 6px;
      border: 1px dashed #374151;
      background: #020617;
      margin-top: 8px;
    }

    .result-loader-text {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 8px;
    }

    .result-loader-bar {
      width: 160px;
      max-width: 70%;
      height: 3px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .result-loader-bar-inner {
      width: 45%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #3b82f6, #22c55e, #38bdf8);
      animation: load 1s infinite;
    }

    /* ===== Lista dos PDFs selecionados ===== */
    .pdf-row{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:14px;
      border:1px dashed #475569;
      background: linear-gradient(180deg, #0b1220, #020617);
      margin-top:10px;
      transition: border-color .15s ease, transform .12s ease, filter .12s ease;
    }

    .pdf-logo-box{
      width:42px;
      height:42px;
      border-radius:12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex-shrink:0;
    }

    .pdf-logo-box img{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: brightness(1.05);
    }

    .pdf-name{
      font-size:12px;
      color:#cbd5f5;
      flex:1 1 auto;
      min-width: 120px;
      max-width: 520px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .pdf-actions{
      margin-left:auto;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .pdf-actions button{
      margin:0;
      padding:6px 10px;
      border-radius:999px;
    }

    .pdf-row-hint{
      font-size:11px;
      color:#9ca3af;
      margin-top: 6px;
    }

    /* teu override final */
    body {
      background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
    }
/* ===== Overlay de Progresso ===== */
.progress-overlay{
  position:fixed;
  inset:0;
  z-index:999999;
  display:flex;
  align-items:center;
  justify-content:center;

  /* fundo escuro + blur do que t√° atr√°s */
  background:rgba(0,0,0,.45);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.progress-card{
  width:min(520px, 92vw);
  border-radius:18px;
  padding:18px 18px 14px;
  background:rgba(20,20,20,.82);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  color:#fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.progress-title{
  font-size:16px;
  font-weight:700;
  letter-spacing:.2px;
  margin-bottom:6px;
}

.progress-sub{
  font-size:13px;
  opacity:.9;
  margin-bottom:12px;
  line-height:1.3;
  word-break: break-word;
}

.progress-bar-wrap{
  width:100%;
  height:12px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  overflow:hidden;
}

.progress-bar{
  height:100%;
  width:0%;
  border-radius:999px;
  background:linear-gradient(90deg, rgba(62,180,255,1), rgba(0,255,170,1));
  transition: width .18s ease;
}

.progress-meta{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
  font-size:12px;
  opacity:.92;
}

.progress-hint{
  margin-top:10px;
  font-size:12px;
  opacity:.85;
}
/* Bot√£o Arquivos Tratados (Excel + PDF) */
.download-treated{
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 16px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.18);
  cursor:pointer;

  /* mix Excel (verde) + PDF (vermelho) */
  background: linear-gradient(90deg, rgba(0,150,90,.92), rgba(255,70,70,.92));
  box-shadow: 0 8px 22px rgba(0,0,0,.22);
  color:#fff;

  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
}

.download-treated:hover{
  filter: brightness(1.03);
  box-shadow: 0 12px 28px rgba(0,0,0,.28);
  transform: translateY(-1px);
}

.download-treated:active{
  transform: translateY(0px) scale(.99);
}

.treated-icons{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 8px;
  border-radius:10px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
}

.treated-icon{
  width:18px;
  height:18px;
  object-fit:contain;
  display:block;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
}

.treated-text{
  font-weight:700;
  letter-spacing:.2px;
  font-size:14px;
  line-height:1;
}

  </style>

<script>
  
  // Config pdf.js
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  // Estado global
  let pagesTexts = [];         // texto consolidado (tudo junto)
  let pdfBuffers = [];         // [{ name, bytes: Uint8Array }]
  let currentTipo = "enel";
  let selectedFiles = [];      // File[] (multi sele√ß√£o)
  let pagesMeta = []; // [{ pdfName, pdfIndex, pageNum }]

  // Config de cada tipo de fatura
  const TIPO_CONFIG = {
    enel: {
      nome: "Enel",
      logo: "https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/enel_logo.png",
      formUrl: "https://forms.office.com/Pages/ResponsePage.aspx?id=h32KRtw5kEm37B9iNhACUjf5h_f9p5hIqNFizEk4SxdUQVAxRFlZQ0g5OVJEOEUxNEpLRENEQ0pNViQlQCN0PWcu&rebef1295d570419382cb678408ce6b56=%22Enel%22"
    },
    equatorial: {
      nome: "Equatorial",
      logo: "https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/equatorial_logo.png",
      formUrl: "https://forms.office.com/SEU_LINK_EQUATORIAL_AQUI"
    },
    outro: {
      nome: "Outro modelo",
      logo: "",
      formUrl: ""
    }
  };

  // P√≥s-processamento de texto
  function cleanText(text) {
    let t = text;

    if (t.normalize) {
      t = t.normalize("NFC");
    }

    t = t.replace(/[^\x09\x0A\x0D\x20-\x7E\u00A0-\u024F]/g, "");
    t = t.replace(/(\S)\s+([√Å√Ä√Ç√É√â√à√ä√ç√å√é√ì√í√î√ï√ö√ô√õ√á√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß])/g, "$1$2");
    t = t.replace(/([√Å√Ä√Ç√É√â√à√ä√ç√å√é√ì√í√î√ï√ö√ô√õ√á√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß])\s+(\S)/g, "$1$2");
    t = t.replace(/([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß])([A-Z√Å√Ä√Ç√É√â√à√ä√ç√å√é√ì√í√î√ï√ö√ô√õ√á])/g, "$1 $2");
    t = t.replace(/ {2,}/g, " ");
    return t;
  }

  // ‚úÖ DEBUG: copiar texto convertido
  function copyDebugText() {
    if (!pagesTexts || pagesTexts.length === 0) {
      alert("Nenhum texto convertido.");
      return;
    }

    let out = "";
    pagesTexts.forEach((txt, i) => {
      out +=
        "=============================\n" +
        "P√ÅGINA " + (i + 1) + "\n" +
        "=============================\n" +
        txt + "\n\n";
    });

    navigator.clipboard.writeText(out)
      .then(() => alert("Texto convertido copiado para o clipboard."))
      .catch(() => alert("Falha ao copiar (permiss√µes do navegador)."));
  }

  // ===== Sele√ß√£o de PDFs (multi) =====
  function updatePdfCountInfo() {
    const info = document.getElementById("pdfCountInfo");
    if (!info) return;
    info.textContent = `${selectedFiles.length} arquivo(s) na fila.`;
  }

  function renderPdfList() {
    const list = document.getElementById("pdfList");
    if (!list) return;

    list.innerHTML = "";

    const pdfLogo = "https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo_pdf.png";

    if (selectedFiles.length === 0) {
      list.innerHTML = `
        <div class="pdf-row">
          <div class="pdf-logo-box">
            <img src="${pdfLogo}" alt="PDF" onerror="this.style.display='none';" />
          </div>
          <div class="pdf-name">Nenhum PDF selecionado</div>
        </div>
      `;
      updatePdfCountInfo();
      return;
    }

    selectedFiles.forEach((f, idx) => {
      const row = document.createElement("div");
      row.className = "pdf-row";
      row.innerHTML = `
        <div class="pdf-logo-box">
          <img src="${pdfLogo}" alt="PDF" onerror="this.style.display='none';" />
        </div>
        <div class="pdf-name" title="${f.name}">${f.name}</div>
        <div class="pdf-actions">
          <button type="button" class="secondary" onclick="removeSelectedFile(${idx})">‚àí</button>
        </div>
      `;
      list.appendChild(row);
    });

    updatePdfCountInfo();
  }

  function pickPdfs() {
    const picker = document.getElementById("pdfPicker");
    if (picker) picker.click();
  }

  function onFilesSelected(input) {
    const files = Array.from(input.files || []);
    if (files.length === 0) return;

    for (const f of files) {
      if (f.type !== "application/pdf") continue;
      const exists = selectedFiles.some(x => x.name === f.name && x.size === f.size);
      if (!exists) selectedFiles.push(f);
    }

    input.value = ""; // permite selecionar o mesmo arquivo novamente depois
    renderPdfList();
  }

  function removeSelectedFile(idx) {
    selectedFiles.splice(idx, 1);
    renderPdfList();
  }

  function clearAllPdfs() {
    selectedFiles = [];
    pagesTexts = [];
    pagesMeta = [];
    pdfBuffers = [];
    renderPdfList();
    updatePdfCountInfo();

    const status = document.getElementById("status");
    if (status) status.textContent = "Lista limpa.";

    const resultDiv = document.getElementById("result");
    if (resultDiv) resultDiv.style.display = "none";
  }

  // ‚úÖ Parser ENEL (TIPO 1 + TIPO 2) - SEM CNPJ/CEP/END/MUN/UF
  function parseEnelFaturas(pages) {
    const resultados = [];

    pages.forEach((txt, idx) => {

      console.group(`üìÑ P√°gina ${idx + 1}`);

      // ==========================
      // DETEC√á√ÉO DE TIPO POR P√ÅGINA
      // ==========================
      const isSP = /\b(S√ÉO\s*PAULO|SAO\s*PAULO|Sao\s*Paulo|S√£o\s*Paulo|\bSP\b)\b/i.test(txt);
      const isCE = /Companhia\s+Energ[e√©]tica\s+do\s+Cear[a√°]/i.test(txt);

      console.log("isSP:", isSP);
      console.log("isCE:", isCE);

      // ==========================
      // ======== TIPO SP =========
      // ==========================
      // ‚ö†Ô∏è CORRE√á√ÉO: SP s√≥ entra se N√ÉO for CE
      if (isSP && !isCE) {

        let numCliente = "";

        let mUC = txt.match(/^\s*(\d{8,12})\s*\/\s*(\d{6,14})\b/);

        if (!mUC) {
          mUC = txt.match(/\bINSC\.?\s*EST:\s*(?:ISENTO|\d+)\s+(\d{7,12})\s+R\$\s*[\d.,]+/i);
        }

        if (!mUC) {
          mUC = txt.match(/\b(\d{7,12})\s+R\$\s*[\d.,]+/i);
        }

        if (mUC) numCliente = mUC[1];

        let mesAno = "";
        let vencimento = "";
        let total = "";

        let mTotal =
          txt.match(/VALOR\s+DO\s+DOCUMENTO:\s*R\$\s*([\d.,]+)/i) ||
          txt.match(/\bR\$\s*([\d.,]+)/i);
        if (mTotal) total = mTotal[1];

        let mVenc =
          txt.match(/DATA\s+DE\s+VENCIMENTO:\s*(\d{2}\/\d{2}\/\d{4})/i) ||
          txt.match(/\b(\d{2}\/\d{2}\/\d{4})\b/i);
        if (mVenc) vencimento = mVenc[1];

        let mMesAno =
          txt.match(/P√°gina\s+\d+\/\d+\s+\d+\s+(\d{2}\/\d{4})\b/i) ||
          txt.match(/\b(\d{2}\/\d{4})\b/i);
        if (mMesAno) mesAno = mMesAno[1];

        const nfMatch = txt.match(/NOTA\s+FISCAL\s+N[¬∫¬∞]?\s*([\d]+)/i);
        const notaFiscal = nfMatch ? nfMatch[1] : "";

        let chaveAcesso = "";
        const chaveNum = txt.match(/chave\s+de\s+acesso:\s*([\d ]{30,})/i);
        if (chaveNum) chaveAcesso = chaveNum[1].replace(/\s+/g, "");

        let bandeiraTarifaria = "";
        const bandMatch = txt.match(/Bandeira\(s\)[^:]*:\s*([A-Za-z√Ä-√∫ ]{3,})/i);
        if (bandMatch) bandeiraTarifaria = bandMatch[1].trim();

        let dataLeituraAnterior = "";
        let dataLeituraAtual = "";
        let numeroDias = "";
        let consumoKwh = "";

        const d3 = txt.match(/\b(\d{2}\/\d{2}\/\d{4})\b\s+\b(\d{2}\/\d{2}\/\d{4})\b\s+\b(\d{2}\/\d{2}\/\d{4})\b/);
        if (d3) {
          dataLeituraAnterior = d3[1];
          dataLeituraAtual    = d3[2];
        }

        const enrg = txt.match(/ENRG\s*ATV[√öU]NICO\s+([\d.,]+)/i);
        if (enrg) consumoKwh = enrg[1];

        if (!numCliente || !mesAno || !vencimento || !total) {
          console.warn("‚ùå SP FALHOU NA VALIDA√á√ÉO", {
            numCliente, mesAno, vencimento, total
          });
          console.groupEnd();
          return;
        }

        console.log("‚úÖ SP OK");

        resultados.push({
          pagina: idx + 1,
          numCliente,
          mesAno,
          vencimento,
          total,
          bandeiraTarifaria,
          dataLeituraAnterior,
          dataLeituraAtual,
          numeroDias,
          consumoKwh,
          chaveAcesso,
          notaFiscal,
          textoBruto: txt
        });

        console.groupEnd();
        return;
      }

      // ==========================
      // ======== TIPO CE =========
      // ==========================
      if (isCE) {

        let numCliente = "";

        const ucMatch =
          txt.match(/INSC\.?\s*EST:?\s*([\d]{6,})/i) ||
          txt.match(/\bNO DO CLIENTE\b[\s\S]{0,80}?(\d{6,})/i);

        if (ucMatch) numCliente = ucMatch[1];

        let mesAno = "";
        const mesAnoMatch = txt.match(/\b(\d{2}\/\d{4})\b/);
        if (mesAnoMatch) mesAno = mesAnoMatch[1];

        let vencimento = "";
        const vencMatch =
          txt.match(/VENCIMENTO\s+(\d{2}\/\d{2}\/\d{4})/i) ||
          txt.match(/\b(\d{2}\/\d{2}\/\d{4})\b/);
        if (vencMatch) vencimento = vencMatch[1];

        let total = "";
        const totalMatch =
          txt.match(/TOTAL\s+A\s+PAGAR\s+R\$\s*([\d.,]+)/i) ||
          txt.match(/TOTAL\s+([\d.,]+)/i) ||
          txt.match(/R\$\s*([\d.,]+)/);
        if (totalMatch) total = totalMatch[1];

        let notaFiscal = "";
        const nfMatch = txt.match(/NOTA FISCAL N¬∫?\s*([\d]+)/i);
        if (nfMatch) notaFiscal = nfMatch[1];

        let chaveAcesso = "";
        const chaveMatch = txt.match(/chave de acesso:\s*([\d\s]{30,})/i);
        if (chaveMatch) chaveAcesso = chaveMatch[1].replace(/\s+/g, "");

        let bandeiraTarifaria = "";
        const bandMatch = txt.match(/Band\.?\s*Tarif\.?\s*:\s*([A-Za-z√Ä-√∫]+)/i);
        if (bandMatch) bandeiraTarifaria = bandMatch[1].trim();

        let dataLeituraAnterior = "";
        let dataLeituraAtual = "";
        let numeroDias = "";
        let consumoKwh = "";

        const leituraMatch = txt.match(
          /(\d{2}\/\d{2}\/\d{4})\s+\d+[.,]\d+\s+(\d{2}\/\d{2}\/\d{4})\s+\d+[.,]\d+\s+\d+[.,]\d+\s+(\d+[.,]\d+)\s+(\d+)/i
        );

        if (leituraMatch) {
          dataLeituraAnterior = leituraMatch[1];
          dataLeituraAtual    = leituraMatch[2];
          consumoKwh          = leituraMatch[3];
          numeroDias          = leituraMatch[4];
        }

        if (!numCliente || !vencimento || !total) {
          console.warn("‚ùå CE FALHOU NA VALIDA√á√ÉO", {
            numCliente, mesAno, vencimento, total
          });
          console.groupEnd();
          return;
        }

        console.log("‚úÖ CE OK");

        resultados.push({
          pagina: idx + 1,
          numCliente,
          mesAno,
          vencimento,
          total,
          bandeiraTarifaria,
          dataLeituraAnterior,
          dataLeituraAtual,
          numeroDias,
          consumoKwh,
          chaveAcesso,
          notaFiscal,
          textoBruto: txt
        });

        console.groupEnd();
        return;
      }

      console.groupEnd();
    });

    return resultados;
  }

  function hideGlobalLoader() {
    const loader = document.getElementById("loader");
    if (loader) loader.style.display = "none";
  }

  window.addEventListener("load", () => {
    setTimeout(hideGlobalLoader, 5000);
    updateTipoUI();
    renderPdfList();
  });

  function setTipo(tipo) {
    currentTipo = tipo;
    updateTipoUI();
  }

  function updateTipoUI() {
    const cfg = TIPO_CONFIG[currentTipo];
    const distLogo = document.getElementById("distLogo");
    const distLabel = document.getElementById("distLabel");
    const registerBtn = document.getElementById("registerButton");
    const tipoNomeSpan = document.getElementById("tipoNomeSpan");

    if (cfg.logo) {
      distLogo.src = cfg.logo;
      distLogo.style.opacity = "1";
    } else {
      distLogo.src = "";
      distLogo.style.opacity = "0.2";
    }

    distLabel.textContent = cfg.nome
      ? `Tipo selecionado: ${cfg.nome}`
      : "Selecione o tipo de fatura acima.";

    if (tipoNomeSpan) tipoNomeSpan.textContent = cfg.nome || "‚Äî";

    if (cfg.formUrl) {
      registerBtn.disabled = false;
      registerBtn.textContent = `Registrar fatura (${cfg.nome})`;
    } else {
      registerBtn.disabled = true;
      registerBtn.textContent = "Registrar fatura (tipo sem formul√°rio)";
    }
  }

  async function handleFileChange() {
    const status        = document.getElementById("status");
    const button        = document.getElementById("convertButton");
    const resultDiv     = document.getElementById("result");
    const resultLoader  = document.getElementById("resultLoader");
    const resultInner   = document.getElementById("resultInner");
    const pageCountSpan = document.getElementById("pageCountSpan");

    const files = selectedFiles.slice();

    if (files.length === 0) {
      alert("Adicione pelo menos 1 PDF.");
      return;
    }

    for (const f of files) {
      if (f.type !== "application/pdf") {
        alert(`O arquivo "${f.name}" n√£o √© PDF.`);
        return;
      }
    }

    pagesTexts = [];
    pagesMeta = [];
    pdfBuffers = [];

    resultDiv.style.display = "block";
    resultLoader.style.display = "flex";
    resultInner.style.display  = "none";
    status.textContent = `Lendo ${files.length} PDF(s), aguarde...`;
    button.disabled = true;

    try {
      let totalPages = 0;

      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        status.textContent = `Lendo PDF ${i + 1}/${files.length}: ${f.name}`;

        const ab = await f.arrayBuffer();
        const bytes = new Uint8Array(ab.slice(0));
        pdfBuffers.push({ name: f.name, bytes });

        const loadingTask = pdfjsLib.getDocument({ data: ab });
        const pdf = await loadingTask.promise;

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          const rawPageText = strings.join(" ");
          const pageText = cleanText(rawPageText).trim();

          pagesTexts.push(pageText);
          pagesMeta.push({ pdfName: f.name, pdfIndex: i, pageNum: pageNum });
          totalPages++;
        }
      }

      if (pageCountSpan) pageCountSpan.textContent = totalPages;

      status.textContent = `Pronto! ${files.length} PDF(s) lido(s), ${totalPages} p√°gina(s) no total.`;
      resultLoader.style.display = "none";
      resultInner.style.display  = "block";
    } catch (err) {
      console.error(err);
      status.textContent = "Erro ao ler os PDFs. Veja o console para detalhes.";
      alert("Deu erro ao ler os PDFs.");
      resultLoader.style.display = "none";
      resultInner.style.display  = "none";
      resultDiv.style.display    = "none";
    } finally {
      button.disabled = false;
    }
  }
let __progressTotal = 0;
let __progressDone = 0;

function showProgressOverlay(total, initialText = "Preparando...") {
  __progressTotal = Math.max(0, Number(total) || 0);
  __progressDone = 0;

  const ov = document.getElementById("progressOverlay");
  const sub = document.getElementById("progressSub");
  const bar = document.getElementById("progressBar");
  const count = document.getElementById("progressCount");
  const pct = document.getElementById("progressPct");

  if (!ov || !sub || !bar || !count || !pct) return;

  ov.style.display = "flex";
  sub.textContent = initialText;

  count.textContent = `0/${__progressTotal}`;
  pct.textContent = `0%`;
  bar.style.width = "0%";
}

function updateProgressOverlay(doneInc = 1, text = "") {
  __progressDone += (Number(doneInc) || 0);
  if (__progressDone < 0) __progressDone = 0;
  if (__progressDone > __progressTotal) __progressDone = __progressTotal;

  const sub = document.getElementById("progressSub");
  const bar = document.getElementById("progressBar");
  const count = document.getElementById("progressCount");
  const pct = document.getElementById("progressPct");

  if (text && sub) sub.textContent = text;

  const percent = __progressTotal > 0
    ? Math.round((__progressDone / __progressTotal) * 100)
    : 0;

  if (count) count.textContent = `${__progressDone}/${__progressTotal}`;
  if (pct) pct.textContent = `${percent}%`;
  if (bar) bar.style.width = `${percent}%`;
}

function hideProgressOverlay(finalText = "") {
  const ov = document.getElementById("progressOverlay");
  const sub = document.getElementById("progressSub");
  if (finalText && sub) sub.textContent = finalText;

  // d√° um tiquinho de tempo pro usu√°rio ver "Conclu√≠do"
  setTimeout(() => {
    if (ov) ov.style.display = "none";
  }, 450);
}

async function downloadArquivosTratados() {
  const status = document.getElementById("status");

  if (!pagesTexts || pagesTexts.length === 0 || !pdfBuffers || pdfBuffers.length === 0) {
    alert("Primeiro clique em Converter para ler os PDFs.");
    return;
  }

  if (currentTipo !== "enel") {
    alert("Download em lote (sem ZIP) dispon√≠vel apenas para ENEL.");
    return;
  }

  // =============================
  // Helpers locais
  // =============================
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  const fmtVencDDMM = (venc) => {
    const m = (venc || "").match(/^(\d{2})\/(\d{2})\/\d{4}$/);
    return m ? `${m[1]}.${m[2]}` : "00.00";
  };

const makePdfName = (uc, nf, venc, idx) => {
  const partes = [];

  if (uc) partes.push(`UC ${uc}`);

  const data = fmtVencDDMM(venc);
  if (data !== "00.00") partes.push(data);

  if (nf) partes.push(`NF ${nf}`);

  const base = partes.join(" ");

  if (!idx || idx === 1) return `${base}.pdf`;
  return `${base} (${String(idx).padStart(2, "0")}).pdf`;
};

  const forceDownload = async (blob, filename) => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // d√° tempo pro browser iniciar o download antes de revogar
    await sleep(420);
    URL.revokeObjectURL(url);
  };

  // Overlay safe calls (se voc√™ colou as fun√ß√µes do overlay)
  const hasOverlay = typeof showProgressOverlay === "function"
    && typeof updateProgressOverlay === "function"
    && typeof hideProgressOverlay === "function";

  try {
    // =============================
    // 1) Parse das faturas
    // =============================
    status.textContent = "Identificando faturas...";
    const faturas = parseEnelFaturas(pagesTexts);

    if (!faturas || faturas.length === 0) {
      alert("Nenhuma fatura ENEL padr√£o encontrada no texto.");
      return;
    }

    // =============================
    // 2) Agrupar por PDF original (pra saber quantos downloads vai ter)
    // =============================
    const byPdf = {}; // { pdfName: [faturas...] }

    for (const f of faturas) {
      const meta = pagesMeta && pagesMeta[f.pagina - 1];
      if (!meta) continue;

      if (!byPdf[meta.pdfName]) byPdf[meta.pdfName] = [];
      byPdf[meta.pdfName].push(f);
    }

    Object.values(byPdf).forEach(list => list.sort((a, b) => a.pagina - b.pagina));

    // total = 1 excel + 1 pdf estruturado + (somente PDFs originais com 1 fatura)
    let totalDownloads = 2;

    for (let i = 0; i < pdfBuffers.length; i++) {
      const list = byPdf[pdfBuffers[i].name];
      if (list && list.length === 1) totalDownloads += 1; // s√≥ 1 fatura => baixa 1 pdf
      // se 0 ou >1 => n√£o baixa nada (ignora)
    }

    if (hasOverlay) showProgressOverlay(totalDownloads, "Preparando downloads...");

    // =============================
    // 3) Excel estruturado
    // =============================
    status.textContent = "Gerando Excel estruturado...";
    if (hasOverlay) updateProgressOverlay(0, "Gerando: EXCEL_ESTRUTURADO.xlsx");

    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet("FATURAS");

    const rows = faturas.map(f => [
      f.pagina,
      f.numCliente,
      f.mesAno,
      f.vencimento,
      f.total,
      f.bandeiraTarifaria,
      f.dataLeituraAnterior,
      f.dataLeituraAtual,
      f.numeroDias,
      f.consumoKwh,
      f.chaveAcesso,
      f.notaFiscal,
      f.textoBruto
    ]);

    sheet.addTable({
      name: "FATURAS",
      ref: "A1",
      headerRow: true,
      totalsRow: false,
      style: { theme: "TableStyleMedium2", showRowStripes: true },
      columns: [
        { name: "PAGINA" },
        { name: "NUM_CLIENTE" },
        { name: "MES_ANO" },
        { name: "VENCIMENTO" },
        { name: "TOTAL" },
        { name: "BANDEIRA_TARIFARIA" },
        { name: "DT_LEIT_ANTERIOR" },
        { name: "DT_LEIT_ATUAL" },
        { name: "NUM_DIAS" },
        { name: "CONSUMO_KWH" },
        { name: "CHAVE_ACESSO" },
        { name: "NOTA_FISCAL" },
        { name: "TEXTO_BRUTO" }
      ],
      rows
    });

    const excelBytes = await workbook.xlsx.writeBuffer();
    const excelBlob = new Blob([excelBytes], {
      type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    });

    if (hasOverlay) updateProgressOverlay(0, "Baixando: EXCEL_ESTRUTURADO.xlsx");
    await forceDownload(excelBlob, "EXCEL_ESTRUTURADO.xlsx");
    if (hasOverlay) updateProgressOverlay(1);
    await sleep(200);

    // =============================
    // 4) PDF estruturado (mesclado)
    // =============================
    status.textContent = "Gerando PDF estruturado...";
    if (hasOverlay) updateProgressOverlay(0, "Gerando: PDF_ESTRUTURADO_ENEL.pdf");

    const mergedPdf = await PDFLib.PDFDocument.create();

    for (let i = 0; i < pdfBuffers.length; i++) {
      const donor = await PDFLib.PDFDocument.load(pdfBuffers[i].bytes);
      const copied = await mergedPdf.copyPages(donor, donor.getPageIndices());
      copied.forEach(p => mergedPdf.addPage(p));
    }

    const mergedPdfBytes = await mergedPdf.save();
    const mergedBlob = new Blob([mergedPdfBytes], { type: "application/pdf" });

    if (hasOverlay) updateProgressOverlay(0, "Baixando: PDF_ESTRUTURADO_ENEL.pdf");
    await forceDownload(mergedBlob, "PDF_ESTRUTURADO_ENEL.pdf");
    if (hasOverlay) updateProgressOverlay(1);
    await sleep(220);

// =============================
// 5) PDFs originais renomeados
// Regra: s√≥ baixar PDFs que tenham EXATAMENTE 1 fatura
// =============================
status.textContent = "Baixando PDFs originais (somente faturas √∫nicas)...";

for (let i = 0; i < pdfBuffers.length; i++) {
  const original = pdfBuffers[i];
  const list = byPdf[original.name];

  // ‚ùå n√£o identificou fatura ‚Üí n√£o baixa
  if (!list || list.length === 0) continue;

  // ‚ùå mais de uma fatura no mesmo PDF ‚Üí n√£o baixar
  if (list.length > 1) {
    console.warn(
      `[IGNORADO] PDF com m√∫ltiplas faturas (${list.length}):`,
      original.name
    );
    continue;
  }

  // ‚úÖ exatamente 1 fatura ‚Üí baixar
  const f = list[0];
  const novoNome = makePdfName(
  f.numCliente,
  f.notaFiscal,
  f.vencimento,
  1
);

  const pdfBlob = new Blob([original.bytes], { type: "application/pdf" });

  if (hasOverlay) updateProgressOverlay(0, `Baixando: ${novoNome}`);
  await forceDownload(pdfBlob, novoNome);
  if (hasOverlay) updateProgressOverlay(1);
  await sleep(220);
}

    status.textContent = "Downloads iniciados com sucesso.";
    if (hasOverlay) hideProgressOverlay("Conclu√≠do! ‚úÖ");
  } catch (e) {
    console.error(e);
    status.textContent = "Erro ao baixar arquivos tratados.";
    if (hasOverlay) hideProgressOverlay("Deu erro. ‚ùå");
    alert("Deu erro ao gerar/baixar os arquivos. Veja o console (F12).");
  }
}


  function openFormAtual() {
    const cfg = TIPO_CONFIG[currentTipo];
    if (!cfg.formUrl) {
      alert("Formul√°rio n√£o configurado para este tipo de fatura.");
      return;
    }
    window.open(cfg.formUrl, "_blank");
  }

  function openPainel() {
    const url = "https://bimobit.github.io/BI/ADM/PROCESSAMENTO%20DE%20FATURAS%20DE%20ENERGIA.html";
    window.open(url, "_blank");
  }
</script>

</head>

<body>
  <!-- Loader global -->
  <div id="loader">
    <img
      id="loader-logo"
      src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo.png"
      alt="Logo"
    >
    <div class="loader-text">Carregando Extruturador de Faturas de Energia...</div>
    <div class="loader-bar">
      <div class="loader-bar-inner"></div>
    </div>
  </div>

  <!-- HEADER FORA DO CARD -->
  <div class="top-header">
    <div class="header-logo-container">
      <img
        class="header-logo"
        src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo.png"
        alt="Logo do Setor"
      />
    </div>
  </div>

  <div class="card">
    <h1>EXTRUTURADOR DE FATURAS DE ENERGIA - MOBIT</h1>

    <p>Escolha a concession√°ria, selecione os PDFs e gere o arquivo Excel.</p>

    <!-- Seletor de tipo de fatura -->
    <div class="tipo-fatura">
      <span><strong>Tipo de fatura:</strong></span>

      <label class="tipo-option">
        <input type="radio" name="tipoFatura" value="enel" checked onclick="setTipo('enel')">
        <span class="tipo-option-content">
          <img
            src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/enel_logo.png"
            alt="Enel"
            class="tipo-option-logo"
          >
        </span>
      </label>

      <!--<label class="tipo-option">
        <input type="radio" name="tipoFatura" value="equatorial" onclick="setTipo('equatorial')">
        <span class="tipo-option-content">
          <img
            src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/equatorial_logo.png"
            alt="Equatorial"
            class="tipo-option-logo"
          >
        </span>
      </label>-->
    </div>

    <!-- Passo 1 -->
    <div class="step-hint">
      <div class="step-bullet">1</div>
      <span><span class="step-arrow">‚ûú</span> Selecione 1 ou mais PDFs da fatura (de uma vez).</span>
    </div>

    <!-- input multi (invis√≠vel) -->
    <input id="pdfPicker" type="file" accept="application/pdf" multiple style="display:none" onchange="onFilesSelected(this)" />

    <!-- Lista de PDFs -->
    <div id="pdfList" style="margin-top:6px;"></div>
    <div class="pdf-row-hint">Dica: clique em ‚ÄúSelecionar PDFs‚Äù e escolha v√°rios de uma vez.</div>

    <!-- Bot√µes -->
    <div class="action-row">
      <button type="button" class="action-btn" onclick="pickPdfs()">
        <span class="action-icon">+</span>
        <span>Selecionar PDFs</span>
      </button>

      <button type="button" class="action-btn danger" onclick="clearAllPdfs()">
        <span class="action-icon">√ó</span>
        <span>Limpar lista</span>
      </button>
    </div>

    <div class="status" style="margin-top:8px;">
      <span id="pdfCountInfo">0 arquivo(s) na fila.</span>
    </div>

    <!-- Passo 2 -->
    <div class="step-hint" style="margin-top:10px;">
      <div class="step-bullet">2</div>
      <span><span class="step-arrow">‚ûú</span> Clique em <strong>"Converter"</strong>.</span>
    </div>

    <button id="convertButton" class="action-btn primary" style="margin-top:8px;" onclick="handleFileChange()">
      <span class="action-icon">
        <img src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/PDF_TO_EXCEL.png" alt="Converter" onerror="this.parentElement.textContent='‚ñ∂';" />
      </span>
      <span>Converter PDF para Excel estruturado</span>
    </button>

    <div id="status" class="status"></div>

    <div id="result">
      <!-- Loader local -->
      <div id="resultLoader" class="result-loader">
        <div class="result-loader-text">Convertendo PDF para texto...</div>
        <div class="result-loader-bar">
          <div class="result-loader-bar-inner"></div>
        </div>
      </div>

      <!-- Conte√∫do final -->
      <div class="step-hint">
        <div class="step-bullet">3</div>
        <span>
          <span class="step-arrow">‚ûú</span>
          Baixe o Excel estruturado, o PDF mesclado e Registre ao lado.
        </span>
      </div>

      <div id="resultInner" style="display:none;">
        <div class="result-layout">
          <!-- Painel principal -->
          <div class="main-output">
            <div class="success-panel">
              <div class="success-header">
                <div class="success-badge">‚úì</div>
                <div>
                  <div class="success-title">PDF processado com sucesso</div>
                  <div class="success-sub">
                    <span id="pageCountSpan">0</span> p√°gina(s) detectadas ‚Ä¢
                    Tipo: <span id="tipoNomeSpan">Enel</span>
                  </div>
                </div>
              </div>

              <div class="success-meta">
                Gere um arquivo Excel pronto para registrar no Form ao lado. O arquivo ser√° processado no Power Automate para Power BI estruturada
                de acordo com a concession√°ria selecionada.
              </div>

              <button class="download-button download-treated" type="button" onclick="downloadArquivosTratados()">
                <span class="treated-icons">
                  <img class="treated-icon" src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo_excel.png" alt="Excel">
                  <img class="treated-icon" src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo_pdf.png" alt="PDF">
                </span>
                <span class="treated-text">
                  Baixar Arquivos Tratados
                </span>
              </button>

              <!-- DEBUG -->
              <!-- 
              <button
                class="download-button"
                type="button"
                style="background: linear-gradient(90deg, #374151, #111827); border-color: rgba(148,163,184,0.25);"
                onclick="copyDebugText()"
              >
                <span>Copiar texto convertido (DEBUG)</span>
              </button>
              -->
            </div>
          </div>

          <!-- Bloco lateral -->
          <div class="side-buttons">
            <div class="side-title">Registrar fatura</div>
            <div class="side-desc">
              Ap√≥s gerar o Excel ou ler os dados, use o bot√£o abaixo para abrir o formul√°rio da concession√°ria.
            </div>

            <div class="dist-block">
              <div class="dist-logo-wrapper">
                <img
                  id="distLogo"
                  class="dist-logo"
                  src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/enel_logo.png"
                  alt="Logo da concession√°ria"
                />
              </div>
              <div id="distLabel" class="dist-label">
                Tipo selecionado: Enel
              </div>
            </div>

            <button
              id="registerButton"
              type="button"
              class="side-button"
              onclick="openFormAtual()"
            >
              Registrar fatura (Enel)
            </button>

            <hr class="side-separator" />

            <div class="side-title" style="font-size: 13px; margin-bottom: 4px;">
              Painel de acompanhamento
            </div>
            <div class="side-desc">
              Consulte o hist√≥rico das faturas registradas.
            </div>

            <button
              type="button"
              class="side-button panel-button"
              onclick="openPainel()"
            >
              Abrir Painel de Acompanhamento
              <img
                class="panel-logo"
                src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/power_bi.png"
                alt="Power BI"
              />
            </button>
          </div>

        </div>
      </div>
    </div>

    <div class="support-info">
      <span><strong>Suporte:</strong> Paulo Victor Lima da Silva</span>
      <span>paulosilva@mobit.com.br</span>
    </div>
  </div>
<!-- OVERLAY DE PROGRESSO (fica por cima de tudo) -->
<div id="progressOverlay" class="progress-overlay" style="display:none;">
  <div class="progress-card">
    <div class="progress-title">Baixando arquivos tratados...</div>

    <div class="progress-sub" id="progressSub">
      Preparando...
    </div>

    <div class="progress-bar-wrap" aria-label="Progresso">
      <div id="progressBar" class="progress-bar"></div>
    </div>

    <div class="progress-meta">
      <span id="progressCount">0/0</span>
      <span id="progressPct">0%</span>
    </div>

    <div class="progress-hint">
      Se o navegador pedir permiss√£o para m√∫ltiplos downloads, clique em <b>Permitir</b>.
    </div>
  </div>
</div>

  <script>
    document.addEventListener('contextmenu', e => e.preventDefault());

    document.addEventListener('keydown', e => {
      const k = (e.key || '').toUpperCase();
      if (
        e.key === 'F12' ||
        (e.ctrlKey && k === 'U') ||
        (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(k))
      ) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);

    (function(){
      let trips = 0;
      setInterval(() => {
        const t0 = performance.now();
        debugger;
        const dt = performance.now() - t0;
        if (dt > 120) {
          trips++;
          if (trips >= 2) document.documentElement.innerHTML = "";
        } else {
          trips = Math.max(0, trips - 1);
        }
      }, 700);
    })();
  </script>
</body>
</html>
