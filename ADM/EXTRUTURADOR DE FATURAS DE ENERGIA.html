<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ADM - EXTRUTURADOR DE FATURAS DE ENERGIA</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/LOGO_PeD.png">

  <!-- pdf.js via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- ExcelJS para gerar XLSX com TABELA de verdade -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <!-- PDF-LIB (mesclar PDFs) -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      background: #111827;
      color: #e5e7eb;
      margin: 0;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 8px;
      text-align: left;
    }

    /* HEADER FORA DO CARD (logo + suporte) */
    .top-header {
      position: relative;
      max-width: 900px;
      margin: 16px auto 0;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .header-logo-container {
      text-align: center;
      margin-bottom: 4px;
    }

    .header-logo {
      max-width: 220px;
      width: 100%;
      height: auto;
      object-fit: contain;
    }

    .support-info {
      right: 20px;
      font-size: 11px;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      text-align: right;
    }

    .support-info span strong {
      color: #e5e7eb;
    }

    .card {
      background: #1f2937;
      border-radius: 10px;
      padding: 16px 20px 18px 20px;
      max-width: 900px;
      margin: 10px auto 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      border: 1px solid #374151;
    }

    button {
      margin-top: 4px;
      margin-right: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #3b82f6;
      color: white;
      font-weight: 500;
      font-size: 13px;
    }

    button.secondary {
      background: #374151;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
      min-height: 16px;
    }

    #result {
      margin-top: 12px;
      display: none;
    }

    /* Hints de passo a passo */
    .step-hint {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .step-bullet {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .step-arrow {
      font-size: 12px;
      opacity: 0.9;
    }

    /* Seletor de tipo de fatura (com logo) */
    .tipo-fatura {
      margin-top: 10px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #d1d5db;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    .tipo-fatura span strong {
      font-size: 12px;
      color: #e5e7eb;
    }

    .tipo-option {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease-in-out;
    }

    .tipo-option input[type="radio"] {
      accent-color: #3b82f6;
      cursor: pointer;
    }

    .tipo-option-content {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tipo-option-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
      filter: brightness(1.05);
    }

    /* Layout da área de resultado (2 blocos lado a lado) */
    .result-layout {
      display: flex;
      gap: 16px;
      align-items: stretch;
      margin-top: 8px;
    }

    .main-output {
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .main-output > .step-hint {
      margin-top: 0;
      margin-bottom: 6px;
    }

    /* Painel de sucesso */
    .success-panel {
      position: relative;
      flex: 1 1 auto;
      padding: 16px 16px 18px 16px;
      border-radius: 12px;
      border: 1px solid #374151;
      background: radial-gradient(circle at top left, #1d4ed8 0%, #020617 45%, #020617 100%);
      box-shadow: 0 8px 24px rgba(15,23,42,0.7);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .success-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .success-badge {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle, #22c55e 0%, #15803d 45%, #052e16 100%);
      box-shadow: 0 0 0 0 rgba(34,197,94,0.7);
      animation: pulse 1.8s infinite;
      font-size: 16px;
    }

    .success-title {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .success-sub {
      font-size: 12px;
      color: #cbd5f5;
    }

    .success-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.7); }
      70% { box-shadow: 0 0 0 12px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }

    /* ===== Botões bonitos ===== */
    .action-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }

    .action-btn{
      margin:0;
      padding:10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(90deg, #374151, #111827);
      color:#e5e7eb;
      font-weight:700;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.28);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }

    .action-btn:hover{
      filter: brightness(1.15);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.34);
    }

    .action-btn:active{
      transform: scale(0.98);
    }

    .action-btn.primary{
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      border: 1px solid rgba(59,130,246,0.35);
    }

    .action-btn.danger{
      background: linear-gradient(90deg, #991b1b, #ef4444);
      border: 1px solid rgba(239,68,68,0.35);
    }

    .action-icon{
      width:28px;
      height:28px;
      border-radius:10px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex-shrink:0;
    }

    .action-icon img{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: brightness(1.05);
    }

    /* ===== Botões de download com gradientes temáticos ===== */
    .download-button {
      margin-top: 4px;
      margin-right: 0;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      min-width: 0;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 10px 22px rgba(0,0,0,0.28);
      transition: transform .12s ease, filter .12s ease;
    }

    .download-icon {
      width: 30px;
      height: 30px;
      object-fit: contain;
      filter: brightness(1.05);
    }

    .download-button:hover {
      filter: brightness(1.10);
      transform: translateY(-1px);
    }

    .download-button:active {
      transform: scale(0.98);
    }

    /* Excel vibe */
    .download-excel{
      background: linear-gradient(90deg, #0f7b3d, #22c55e);
      border-color: rgba(34,197,94,0.40);
    }

    /* PDF vibe */
    .download-pdf{
      background: linear-gradient(90deg, #b91c1c, #ef4444);
      border-color: rgba(239,68,68,0.40);
    }

    .download-tip {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* Caixa lateral */
    .side-buttons {
      flex: 0 0 260px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #0b0f19;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 14px;
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.4);
    }

    .side-title {
      font-size: 14px;
      font-weight: 700;
      color: #e5e7eb;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .side-desc {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .side-separator {
      border: 0;
      border-top: 1px dashed #1f2937;
      margin: 8px 0;
    }

    /* Bloco da logo da concessionária */
    .dist-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 10px;
      background: #020617;
      border: 1px dashed #1f2937;
    }

    .dist-logo-wrapper {
      width: 90px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dist-logo {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      filter: brightness(1.05);
    }

    .dist-label {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }

    /* Botões laterais chamativos */
    .side-button {
      position: relative;
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      cursor: pointer;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      transition: all 0.15s ease-in-out;
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.35);
      text-align: center;
      margin: 0;
    }

    .side-button:hover {
      filter: brightness(1.2);
      transform: translateY(-1px);
    }

    .side-button:active {
      transform: scale(0.96);
    }

    /* Botão do painel com logo do Power BI */
    .panel-button {
      position: relative;
      padding-right: 46px;
      padding-left: 12px;
      background: linear-gradient(90deg, #f2c811, #f59e0b);
      box-shadow: 0 4px 16px rgba(242, 200, 17, 0.45);
      color: #111827;
    }

    .panel-logo {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      object-fit: contain;
      pointer-events: none;
      filter: brightness(1.05);
    }

    /* Tela de loading global */
    #loader {
      position: fixed;
      inset: 0;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
    }

    #loader-logo {
      width: 200px;
      max-width: 60vw;
      margin-bottom: 12px;
    }

    .loader-text {
      color: #e5e7eb;
      font-size: 14px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .loader-bar {
      margin-top: 12px;
      width: 180px;
      max-width: 70vw;
      height: 4px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .loader-bar-inner {
      width: 40%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #1d4ed8, #38bdf8, #22c55e);
      animation: load 1.2s infinite;
    }

    @keyframes load {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(250%); }
    }

    /* Loader local na área do resultado */
    .result-loader {
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      height: 160px;
      border-radius: 6px;
      border: 1px dashed #374151;
      background: #020617;
      margin-top: 8px;
    }

    .result-loader-text {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 8px;
    }

    .result-loader-bar {
      width: 160px;
      max-width: 70%;
      height: 3px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .result-loader-bar-inner {
      width: 45%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #3b82f6, #22c55e, #38bdf8);
      animation: load 1s infinite;
    }

    /* ===== Lista dos PDFs selecionados ===== */
    .pdf-row{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:14px;
      border:1px dashed #475569;
      background: linear-gradient(180deg, #0b1220, #020617);
      margin-top:10px;
      transition: border-color .15s ease, transform .12s ease, filter .12s ease;
    }

    .pdf-logo-box{
      width:42px;
      height:42px;
      border-radius:12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex-shrink:0;
    }

    .pdf-logo-box img{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: brightness(1.05);
    }

    .pdf-name{
      font-size:12px;
      color:#cbd5f5;
      flex:1 1 auto;
      min-width: 120px;
      max-width: 520px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .pdf-actions{
      margin-left:auto;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .pdf-actions button{
      margin:0;
      padding:6px 10px;
      border-radius:999px;
    }

    .pdf-row-hint{
      font-size:11px;
      color:#9ca3af;
      margin-top: 6px;
    }

    /* teu override final */
    body {
      background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
    }
  </style>

<script>
  // Config pdf.js
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  // Estado global
  let pagesTexts = [];         // texto consolidado (tudo junto)
  let pdfBuffers = [];         // [{ name, bytes: Uint8Array }]
  let currentTipo = "enel";
  let selectedFiles = [];      // File[] (multi seleção)

  // Config de cada tipo de fatura
  const TIPO_CONFIG = {
    enel: {
      nome: "Enel",
      logo: "https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/enel_logo.png",
      formUrl: "https://forms.office.com/Pages/ResponsePage.aspx?id=h32KRtw5kEm37B9iNhACUjf5h_f9p5hIqNFizEk4SxdUQVAxRFlZQ0g5OVJEOEUxNEpLRENEQ0pNViQlQCN0PWcu&rebef1295d570419382cb678408ce6b56=%22Enel%22"
    },
    equatorial: {
      nome: "Equatorial",
      logo: "https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/equatorial_logo.png",
      formUrl: "https://forms.office.com/SEU_LINK_EQUATORIAL_AQUI"
    },
    outro: {
      nome: "Outro modelo",
      logo: "",
      formUrl: ""
    }
  };

  // Pós-processamento de texto
  function cleanText(text) {
    let t = text;

    if (t.normalize) {
      t = t.normalize("NFC");
    }

    t = t.replace(/[^\x09\x0A\x0D\x20-\x7E\u00A0-\u024F]/g, "");
    t = t.replace(/(\S)\s+([ÁÀÂÃÉÈÊÍÌÎÓÒÔÕÚÙÛÇáàâãéèêíìîóòôõúùûç])/g, "$1$2");
    t = t.replace(/([ÁÀÂÃÉÈÊÍÌÎÓÒÔÕÚÙÛÇáàâãéèêíìîóòôõúùûç])\s+(\S)/g, "$1$2");
    t = t.replace(/([a-záàâãéèêíìîóòôõúùûç])([A-ZÁÀÂÃÉÈÊÍÌÎÓÒÔÕÚÙÛÇ])/g, "$1 $2");
    t = t.replace(/ {2,}/g, " ");
    return t;
  }

  // ✅ DEBUG: copiar texto convertido
  function copyDebugText() {
    if (!pagesTexts || pagesTexts.length === 0) {
      alert("Nenhum texto convertido.");
      return;
    }

    let out = "";
    pagesTexts.forEach((txt, i) => {
      out +=
        "=============================\n" +
        "PÁGINA " + (i + 1) + "\n" +
        "=============================\n" +
        txt + "\n\n";
    });

    navigator.clipboard.writeText(out)
      .then(() => alert("Texto convertido copiado para o clipboard."))
      .catch(() => alert("Falha ao copiar (permissões do navegador)."));
  }

  // ===== Seleção de PDFs (multi) =====
  function updatePdfCountInfo() {
    const info = document.getElementById("pdfCountInfo");
    if (!info) return;
    info.textContent = `${selectedFiles.length} arquivo(s) na fila.`;
  }

  function renderPdfList() {
    const list = document.getElementById("pdfList");
    if (!list) return;

    list.innerHTML = "";

    const pdfLogo = "https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo_pdf.png";

    if (selectedFiles.length === 0) {
      list.innerHTML = `
        <div class="pdf-row">
          <div class="pdf-logo-box">
            <img src="${pdfLogo}" alt="PDF" onerror="this.style.display='none';" />
          </div>
          <div class="pdf-name">Nenhum PDF selecionado</div>
        </div>
      `;
      updatePdfCountInfo();
      return;
    }

    selectedFiles.forEach((f, idx) => {
      const row = document.createElement("div");
      row.className = "pdf-row";
      row.innerHTML = `
        <div class="pdf-logo-box">
          <img src="${pdfLogo}" alt="PDF" onerror="this.style.display='none';" />
        </div>
        <div class="pdf-name" title="${f.name}">${f.name}</div>
        <div class="pdf-actions">
          <button type="button" class="secondary" onclick="removeSelectedFile(${idx})">−</button>
        </div>
      `;
      list.appendChild(row);
    });

    updatePdfCountInfo();
  }

  function pickPdfs() {
    const picker = document.getElementById("pdfPicker");
    if (picker) picker.click();
  }

  function onFilesSelected(input) {
    const files = Array.from(input.files || []);
    if (files.length === 0) return;

    for (const f of files) {
      if (f.type !== "application/pdf") continue;
      const exists = selectedFiles.some(x => x.name === f.name && x.size === f.size);
      if (!exists) selectedFiles.push(f);
    }

    input.value = ""; // permite selecionar o mesmo arquivo novamente depois
    renderPdfList();
  }

  function removeSelectedFile(idx) {
    selectedFiles.splice(idx, 1);
    renderPdfList();
  }

  function clearAllPdfs() {
    selectedFiles = [];
    pagesTexts = [];
    pdfBuffers = [];
    renderPdfList();
    updatePdfCountInfo();

    const status = document.getElementById("status");
    if (status) status.textContent = "Lista limpa.";

    const resultDiv = document.getElementById("result");
    if (resultDiv) resultDiv.style.display = "none";
  }

  // ✅ Parser ENEL (TIPO 1 + TIPO 2) - SEM CNPJ/CEP/END/MUN/UF
  function parseEnelFaturas(pages) {
    const resultados = [];

    pages.forEach((txt, idx) => {

  // ==========================
  // DETECÇÃO DE TIPO POR PÁGINA
  // ==========================
  const isSP = /\b(SÃO\s*PAULO|SAO\s*PAULO|Sao\s*Paulo|São\s*Paulo|\bSP\b)\b/i.test(txt);
  const isCE = /\bCE\b/i.test(txt);

  // ==========================
  // ==========================
  // ======== TIPO SP =========
  // ==========================
  // ==========================
  if (isSP) {

    // ---------- NUM_CLIENTE
    let numCliente = "";
    const nc = txt.match(/INSC\.?\s*EST:\s*(?:ISENTO\s*)?(\d{6,})/i);
    if (nc) numCliente = nc[1];

    // ---------- MES/ANO, VENCIMENTO, TOTAL
    let mesAno = "";
    let vencimento = "";
    let total = "";

    const mSP = txt.match(/R\$\s*([\d.,]+)\s+(\d{2}\/\d{2}\/\d{4}).{0,200}?\b(\d{2}\/\d{4})\b/i);
    if (mSP) {
      total      = mSP[1];
      vencimento = mSP[2];
      mesAno     = mSP[3];
    }

    if (!numCliente || !mesAno || !vencimento || !total) return;

    // ---------- NF + CHAVE
    const nfMatch = txt.match(/NOTA FISCAL Nº?\s*([\d]+)/i);
    const notaFiscal = nfMatch ? nfMatch[1] : "";

// ---------- CHAVE DE ACESSO (SP) - 2 modos
    let chaveAcesso = "";

    // (1) Modo 1: "Chave de acesso: 3525 1261 ..."
    const chaveNum = txt.match(/chave\s+de\s+acesso:\s*([\d ]{30,})/i);
    if (chaveNum) {
      chaveAcesso = chaveNum[1].replace(/\s+/g, "");
    } else {
      // (2) Modo 2: "Nota Fiscal de Conta de Energia Eletrica 4229.EF53...."
      const chaveHex = txt.match(/Nota\s+Fiscal\s+de\s+Conta\s+de\s+Energia\s+Eletrica\s+([0-9A-F.]{15,})/i)
        || txt.match(/\b([0-9A-F]{4}(?:\.[0-9A-F]{4}){3,})\b/i); // fallback bem direto

      if (chaveHex) {
        // normaliza: tira pontos, deixa só HEX
        chaveAcesso = (chaveHex[1] || "").replace(/[^0-9A-F]/gi, "").toUpperCase();
      }
    }

    // ---------- BANDEIRA
    let bandeiraTarifaria = "";
    const bandMatch = txt.match(/Bandeira\(s\)\s*tarif[áa]ria\(s\).*?:\s*([A-Za-zÀ-ú ]+)/i);
    if (bandMatch) bandeiraTarifaria = bandMatch[1].trim();

    // ---------- LEITURAS / CONSUMO / DIAS (SP)
    let dataLeituraAnterior = "";
    let dataLeituraAtual = "";
    let numeroDias = "";
    let consumoKwh = "";

    // Datas (anterior / atual / próxima)
    const d3 = txt.match(/\b(\d{2}\/\d{2}\/\d{4})\b\s+\b(\d{2}\/\d{2}\/\d{4})\b\s+\b(\d{2}\/\d{2}\/\d{4})\b/);
    if (d3) {
      dataLeituraAnterior = d3[1];
      dataLeituraAtual    = d3[2];
    }

    // Consumo + dias pela linha do mês (NOV/25 72,000 30 CAL)
    function mesAnoToMesAbrev(mesAno) {
      const mm = parseInt(mesAno.slice(0,2), 10);
      const yy = mesAno.slice(5,7);
      const map = {1:"JAN",2:"FEV",3:"MAR",4:"ABR",5:"MAI",6:"JUN",7:"JUL",8:"AGO",9:"SET",10:"OUT",11:"NOV",12:"DEZ"};
      return map[mm] ? `${map[mm]}/${yy}` : "";
    }

    const tagMes = mesAnoToMesAbrev(mesAno);
    if (tagMes) {
      const reLinhaMes = new RegExp(`\\b${tagMes.replace("/","\\/")}\\b\\s+([\\d.,]+)\\s+(\\d{1,3})\\s+CAL\\b`, "i");
      const lm = txt.match(reLinhaMes);
      if (lm) {
        consumoKwh = lm[1];
        numeroDias = lm[2];
      }
    }

    // Fallback consumo
    if (!consumoKwh) {
      const enrg = txt.match(/ENRG\s*ATV[ÚU]NICO\s+([\d.,]+)/i);
      if (enrg) consumoKwh = enrg[1];
    }

    resultados.push({
      pagina: idx + 1,
      numCliente,
      mesAno,
      vencimento,
      total,
      bandeiraTarifaria,
      dataLeituraAnterior,
      dataLeituraAtual,
      numeroDias,
      consumoKwh,
      chaveAcesso,
      notaFiscal,
      textoBruto: txt
    });

    return;
  }

  // ==========================
  // ==========================
  // ======== TIPO CE =========
  // ==========================
  // ==========================
  if (isCE) {

    const main = txt.match(
      /INSC\. EST:\s*\d+\s+(\d+)\s+(\d{2}\/\d{4})\s+(\d{2}\/\d{2}\/\d{4})\s+R\$ ?([\d.,]+)/i
    );
    if (!main) return;

    const numCliente = main[1];
    const mesAno     = main[2];
    const vencimento = main[3];
    const total      = main[4];

    const nfMatch = txt.match(/NOTA FISCAL Nº?\s*([\d]+)/i);
    const notaFiscal = nfMatch ? nfMatch[1] : "";

    const chaveMatch = txt.match(/chave de acesso:\s*([\d ]{30,})/i);
    let chaveAcesso = "";
    if (chaveMatch) chaveAcesso = chaveMatch[1].replace(/\s+/g, "");

    let bandeiraTarifaria = "";
    const bandMatch = txt.match(/Band\.\s*Tarif\.\s*:\s*([A-Za-zÀ-ú]+)/i);
    if (bandMatch) bandeiraTarifaria = bandMatch[1].trim();

    let dataLeituraAnterior = "";
    let dataLeituraAtual = "";
    let numeroDias = "";
    let consumoKwh = "";

    const leituraMatch = txt.match(
      /(\d{2}\/\d{2}\/\d{4})\s+\d+\.\d+\s+(\d{2}\/\d{2}\/\d{4})\s+\d+\.\d+\s+\d+\.\d+\s+(\d+\.\d+)\s+(\d+)/i
    );

    if (leituraMatch) {
      dataLeituraAnterior = leituraMatch[1];
      dataLeituraAtual    = leituraMatch[2];
      consumoKwh          = leituraMatch[3];
      numeroDias          = leituraMatch[4];
    }

    resultados.push({
      pagina: idx + 1,
      numCliente,
      mesAno,
      vencimento,
      total,
      bandeiraTarifaria,
      dataLeituraAnterior,
      dataLeituraAtual,
      numeroDias,
      consumoKwh,
      chaveAcesso,
      notaFiscal,
      textoBruto: txt
    });

    return;
  }

});

    return resultados;
  }

  function hideGlobalLoader() {
    const loader = document.getElementById("loader");
    if (loader) loader.style.display = "none";
  }

  window.addEventListener("load", () => {
    setTimeout(hideGlobalLoader, 5000);
    updateTipoUI();
    renderPdfList();
  });

  function setTipo(tipo) {
    currentTipo = tipo;
    updateTipoUI();
  }

  function updateTipoUI() {
    const cfg = TIPO_CONFIG[currentTipo];
    const distLogo = document.getElementById("distLogo");
    const distLabel = document.getElementById("distLabel");
    const registerBtn = document.getElementById("registerButton");
    const tipoNomeSpan = document.getElementById("tipoNomeSpan");

    if (cfg.logo) {
      distLogo.src = cfg.logo;
      distLogo.style.opacity = "1";
    } else {
      distLogo.src = "";
      distLogo.style.opacity = "0.2";
    }

    distLabel.textContent = cfg.nome
      ? `Tipo selecionado: ${cfg.nome}`
      : "Selecione o tipo de fatura acima.";

    if (tipoNomeSpan) tipoNomeSpan.textContent = cfg.nome || "—";

    if (cfg.formUrl) {
      registerBtn.disabled = false;
      registerBtn.textContent = `Registrar fatura (${cfg.nome})`;
    } else {
      registerBtn.disabled = true;
      registerBtn.textContent = "Registrar fatura (tipo sem formulário)";
    }
  }

  async function handleFileChange() {
    const status        = document.getElementById("status");
    const button        = document.getElementById("convertButton");
    const resultDiv     = document.getElementById("result");
    const resultLoader  = document.getElementById("resultLoader");
    const resultInner   = document.getElementById("resultInner");
    const pageCountSpan = document.getElementById("pageCountSpan");

    const files = selectedFiles.slice();

    if (files.length === 0) {
      alert("Adicione pelo menos 1 PDF.");
      return;
    }

    for (const f of files) {
      if (f.type !== "application/pdf") {
        alert(`O arquivo "${f.name}" não é PDF.`);
        return;
      }
    }

    pagesTexts = [];
    pdfBuffers = [];

    resultDiv.style.display = "block";
    resultLoader.style.display = "flex";
    resultInner.style.display  = "none";
    status.textContent = `Lendo ${files.length} PDF(s), aguarde...`;
    button.disabled = true;

    try {
      let totalPages = 0;

      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        status.textContent = `Lendo PDF ${i + 1}/${files.length}: ${f.name}`;

        const ab = await f.arrayBuffer();
        const bytes = new Uint8Array(ab.slice(0));
        pdfBuffers.push({ name: f.name, bytes });

        const loadingTask = pdfjsLib.getDocument({ data: ab });
        const pdf = await loadingTask.promise;

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          const rawPageText = strings.join(" ");
          const pageText = cleanText(rawPageText).trim();

          pagesTexts.push(pageText);
          totalPages++;
        }
      }

      if (pageCountSpan) pageCountSpan.textContent = totalPages;

      status.textContent = `Pronto! ${files.length} PDF(s) lido(s), ${totalPages} página(s) no total.`;
      resultLoader.style.display = "none";
      resultInner.style.display  = "block";
    } catch (err) {
      console.error(err);
      status.textContent = "Erro ao ler os PDFs. Veja o console para detalhes.";
      alert("Deu erro ao ler os PDFs.");
      resultLoader.style.display = "none";
      resultInner.style.display  = "none";
      resultDiv.style.display    = "none";
    } finally {
      button.disabled = false;
    }
  }

  // Gera XLSX conforme o tipo atual
  async function downloadXlsx() {
    const status = document.getElementById("status");

    if (!pagesTexts || pagesTexts.length === 0) {
      alert("Nenhum texto de página encontrado. Converta o PDF primeiro.");
      return;
    }

    try {
      const workbook = new ExcelJS.Workbook();
      const sheet = workbook.addWorksheet("FATURAS");

      if (currentTipo === "enel") {
        const faturas = parseEnelFaturas(pagesTexts);

        if (faturas.length === 0) {
          alert("Nenhuma fatura ENEL padrão encontrada no texto.");
          return;
        }

        // ✅ SEM CNPJ/CEP/END/MUN/UF
        const rows = faturas.map(f => [
          f.pagina,
          f.numCliente,
          f.mesAno,
          f.vencimento,
          f.total,
          f.bandeiraTarifaria,
          f.dataLeituraAnterior,
          f.dataLeituraAtual,
          f.numeroDias,
          f.consumoKwh,
          f.chaveAcesso,
          f.notaFiscal,
          f.textoBruto
        ]);

        sheet.addTable({
          name: "FATURAS",
          ref: "A1",
          headerRow: true,
          totalsRow: false,
          style: {
            theme: "TableStyleMedium2",
            showRowStripes: true
          },
          columns: [
            { name: "PAGINA",             filterButton: true },
            { name: "NUM_CLIENTE",        filterButton: true },
            { name: "MES_ANO",            filterButton: true },
            { name: "VENCIMENTO",         filterButton: true },
            { name: "TOTAL",              filterButton: true },
            { name: "BANDEIRA_TARIFARIA", filterButton: true },
            { name: "DT_LEIT_ANTERIOR",   filterButton: true },
            { name: "DT_LEIT_ATUAL",      filterButton: true },
            { name: "NUM_DIAS",           filterButton: true },
            { name: "CONSUMO_KWH",        filterButton: true },
            { name: "CHAVE_ACESSO",       filterButton: true },
            { name: "NOTA_FISCAL",        filterButton: true },
            { name: "TEXTO_BRUTO",        filterButton: false }
          ],
          rows: rows
        });

        sheet.getColumn(1).width  = 8;
        sheet.getColumn(2).width  = 14;
        sheet.getColumn(3).width  = 10;
        sheet.getColumn(4).width  = 12;
        sheet.getColumn(5).width  = 12;
        sheet.getColumn(6).width  = 22;
        sheet.getColumn(7).width  = 14;
        sheet.getColumn(8).width  = 14;
        sheet.getColumn(9).width  = 10;
        sheet.getColumn(10).width = 14;
        sheet.getColumn(11).width = 36;
        sheet.getColumn(12).width = 14;
        sheet.getColumn(13).width = 120;

      } else {
        const rows = pagesTexts.map((txt, idx) => [idx + 1, txt]);

        sheet.addTable({
          name: "FATURAS",
          ref: "A1",
          headerRow: true,
          totalsRow: false,
          style: {
            theme: "TableStyleMedium9",
            showRowStripes: true
          },
          columns: [
            { name: "PAGINA",      filterButton: true },
            { name: "TEXTO_BRUTO", filterButton: false }
          ],
          rows: rows
        });

        sheet.getColumn(1).width = 8;
        sheet.getColumn(2).width = 120;
      }

      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob(
        [buffer],
        { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }
      );

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = currentTipo === "enel" ? "FATURAS_ENEL.xlsx" : "FATURAS.xlsx";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      status.textContent = "Arquivo Excel gerado com sucesso.";
    } catch (e) {
      console.error(e);
      alert("Erro ao gerar o arquivo Excel.");
      status.textContent = "Erro ao gerar o arquivo Excel.";
    }
  }

  async function downloadMergedPdf() {
    const status = document.getElementById("status");

    if (!pdfBuffers || pdfBuffers.length === 0) {
      alert("Nenhum PDF em memória. Primeiro clique em Converter.");
      return;
    }

    try {
      status.textContent = `Mesclando ${pdfBuffers.length} PDF(s)...`;

      const mergedPdf = await PDFLib.PDFDocument.create();

      for (let i = 0; i < pdfBuffers.length; i++) {
        const donor = await PDFLib.PDFDocument.load(pdfBuffers[i].bytes);
        const copiedPages = await mergedPdf.copyPages(donor, donor.getPageIndices());
        copiedPages.forEach(p => mergedPdf.addPage(p));
      }

      const mergedBytes = await mergedPdf.save();
      const blob = new Blob([mergedBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `FATURAS_MESCLADO_${currentTipo.toUpperCase()}.pdf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      status.textContent = "PDF mesclado gerado com sucesso.";
    } catch (e) {
      console.error(e);
      alert("Erro ao mesclar os PDFs.");
      status.textContent = "Erro ao mesclar os PDFs.";
    }
  }

  function openFormAtual() {
    const cfg = TIPO_CONFIG[currentTipo];
    if (!cfg.formUrl) {
      alert("Formulário não configurado para este tipo de fatura.");
      return;
    }
    window.open(cfg.formUrl, "_blank");
  }

  function openPainel() {
    const url = "https://bimobit.github.io/BI/ADM/PROCESSAMENTO%20DE%20FATURAS%20DE%20ENERGIA.html";
    window.open(url, "_blank");
  }
</script>

</head>

<body>
  <!-- Loader global -->
  <div id="loader">
    <img
      id="loader-logo"
      src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo.png"
      alt="Logo"
    >
    <div class="loader-text">Carregando Extruturador de Faturas de Energia...</div>
    <div class="loader-bar">
      <div class="loader-bar-inner"></div>
    </div>
  </div>

  <!-- HEADER FORA DO CARD -->
  <div class="top-header">
    <div class="header-logo-container">
      <img
        class="header-logo"
        src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo.png"
        alt="Logo do Setor"
      />
    </div>
  </div>

  <div class="card">
    <h1>EXTRUTURADOR DE FATURAS DE ENERGIA - MOBIT</h1>

    <p>Escolha a concessionária, selecione os PDFs e gere o arquivo Excel.</p>

    <!-- Seletor de tipo de fatura -->
    <div class="tipo-fatura">
      <span><strong>Tipo de fatura:</strong></span>

      <label class="tipo-option">
        <input type="radio" name="tipoFatura" value="enel" checked onclick="setTipo('enel')">
        <span class="tipo-option-content">
          <img
            src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/enel_logo.png"
            alt="Enel"
            class="tipo-option-logo"
          >
        </span>
      </label>

      <!--
      <label class="tipo-option">
        <input type="radio" name="tipoFatura" value="equatorial" onclick="setTipo('equatorial')">
        <span class="tipo-option-content">
          <img
            src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/equatorial_logo.png"
            alt="Equatorial"
            class="tipo-option-logo"
          >
        </span>
      </label>
      -->
    </div>
    
    <!-- Passo 1 -->
    <div class="step-hint">
      <div class="step-bullet">1</div>
      <span><span class="step-arrow">➜</span> Selecione 1 ou mais PDFs da fatura (de uma vez).</span>
    </div>

    <!-- input multi (invisível) -->
    <input id="pdfPicker" type="file" accept="application/pdf" multiple style="display:none" onchange="onFilesSelected(this)" />

    <!-- Lista de PDFs -->
    <div id="pdfList" style="margin-top:6px;"></div>
    <div class="pdf-row-hint">Dica: clique em “Selecionar PDFs” e escolha vários de uma vez.</div>

    <!-- Botões -->
    <div class="action-row">
      <button type="button" class="action-btn" onclick="pickPdfs()">
        <span class="action-icon">+</span>
        <span>Selecionar PDFs</span>
      </button>

      <button type="button" class="action-btn danger" onclick="clearAllPdfs()">
        <span class="action-icon">×</span>
        <span>Limpar lista</span>
      </button>
    </div>

    <div class="status" style="margin-top:8px;">
      <span id="pdfCountInfo">0 arquivo(s) na fila.</span>
    </div>

    <!-- Passo 2 -->
    <div class="step-hint" style="margin-top:10px;">
      <div class="step-bullet">2</div>
      <span><span class="step-arrow">➜</span> Clique em <strong>"Converter"</strong>.</span>
    </div>

    <button id="convertButton" class="action-btn primary" style="margin-top:8px;" onclick="handleFileChange()">
      <span class="action-icon">
        <img src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/PDF_TO_EXCEL.png" alt="Converter" onerror="this.parentElement.textContent='▶';" />
      </span>
      <span>Converter PDF para Excel estruturado</span>
    </button>

    <div id="status" class="status"></div>

    <div id="result">
      <!-- Loader local -->
      <div id="resultLoader" class="result-loader">
        <div class="result-loader-text">Convertendo PDF para texto...</div>
        <div class="result-loader-bar">
          <div class="result-loader-bar-inner"></div>
        </div>
      </div>

      <!-- Conteúdo final -->
      <div class="step-hint">
        <div class="step-bullet">3</div>
        <span>
          <span class="step-arrow">➜</span>
          Baixe o Excel estruturado, o PDF mesclado e Registre ao lado.
        </span>
      </div>

      <div id="resultInner" style="display:none;">
        <div class="result-layout">
          <!-- Painel principal -->
          <div class="main-output">
            <div class="success-panel">
              <div class="success-header">
                <div class="success-badge">✓</div>
                <div>
                  <div class="success-title">PDF processado com sucesso</div>
                  <div class="success-sub">
                    <span id="pageCountSpan">0</span> página(s) detectadas •
                    Tipo: <span id="tipoNomeSpan">Enel</span>
                  </div>
                </div>
              </div>

              <div class="success-meta">
                Gere um arquivo Excel pronto para registrar no Form ao lado. O arquivo será processado no Power Automate para Power BI estruturada
                de acordo com a concessionária selecionada.
              </div>

              <!-- Excel -->
              <button class="download-button download-excel" type="button" onclick="downloadXlsx()">
                <img
                  class="download-icon"
                  src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo_excel.png"
                  alt="Excel"
                >
                <span>Baixar Excel Estruturado</span>
              </button>

              <!-- PDF mesclado -->
              <button class="download-button download-pdf" type="button" onclick="downloadMergedPdf()">
                <img
                  class="download-icon"
                  src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo_pdf.png"
                  alt="PDF"
                >
                <span>Baixar PDF mesclado</span>
              </button>

              <!-- DEBUG -->
              <!---->
              <button
                class="download-button"
                type="button"
                style="background: linear-gradient(90deg, #374151, #111827); border-color: rgba(148,163,184,0.25);"
                onclick="copyDebugText()"
              >
                <span>Copiar texto convertido (DEBUG)</span>
              </button>
              
            </div>
          </div>

          <!-- Bloco lateral -->
          <div class="side-buttons">
            <div class="side-title">Registrar fatura</div>
            <div class="side-desc">
              Após gerar o Excel ou ler os dados, use o botão abaixo para abrir o formulário da concessionária.
            </div>

            <div class="dist-block">
              <div class="dist-logo-wrapper">
                <img
                  id="distLogo"
                  class="dist-logo"
                  src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/enel_logo.png"
                  alt="Logo da concessionária"
                />
              </div>
              <div id="distLabel" class="dist-label">
                Tipo selecionado: Enel
              </div>
            </div>

            <button
              id="registerButton"
              type="button"
              class="side-button"
              onclick="openFormAtual()"
            >
              Registrar fatura (Enel)
            </button>

            <hr class="side-separator" />

            <div class="side-title" style="font-size: 13px; margin-bottom: 4px;">
              Painel de acompanhamento
            </div>
            <div class="side-desc">
              Consulte o histórico das faturas registradas.
            </div>

            <button
              type="button"
              class="side-button panel-button"
              onclick="openPainel()"
            >
              Abrir Painel de Acompanhamento
              <img
                class="panel-logo"
                src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/power_bi.png"
                alt="Power BI"
              />
            </button>
          </div>

        </div>
      </div>
    </div>

    <div class="support-info">
      <span><strong>Suporte:</strong> Paulo Victor Lima da Silva</span>
      <span>paulosilva@mobit.com.br</span>
    </div>
  </div>

  <script>
    document.addEventListener('contextmenu', e => e.preventDefault());

    document.addEventListener('keydown', e => {
      const k = (e.key || '').toUpperCase();
      if (
        e.key === 'F12' ||
        (e.ctrlKey && k === 'U') ||
        (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(k))
      ) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);

    (function(){
      let trips = 0;
      setInterval(() => {
        const t0 = performance.now();
        debugger;
        const dt = performance.now() - t0;
        if (dt > 120) {
          trips++;
          if (trips >= 2) document.documentElement.innerHTML = "";
        } else {
          trips = Math.max(0, trips - 1);
        }
      }, 700);
    })();
  </script>
</body>

</html>
