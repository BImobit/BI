<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ADM - PROCESSAMENTO DE FATURAS DE ENERGIA</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/LOGO_PeD.png">

  <!-- pdf.js via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- ExcelJS para gerar XLSX com TABELA de verdade -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      background: #111827;
      color: #e5e7eb;
      margin: 0;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 8px;
      text-align: left;
    }

    /* HEADER FORA DO CARD (logo + suporte) */
    .top-header {
      position: relative;
      max-width: 900px;
      margin: 16px auto 0;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .header-logo-container {
      text-align: center;
      margin-bottom: 4px;
    }

    .header-logo {
      max-width: 220px;
      width: 100%;
      height: auto;
      object-fit: contain;
    }

    .support-info {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      gap: 2px;
      align-items: flex-end;
      text-align: right;
    }

    .support-info span strong {
      color: #e5e7eb;
    }

    .card {
      background: #1f2937;
      border-radius: 10px;
      padding: 16px 20px 18px 20px;
      max-width: 900px;
      margin: 10px auto 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      border: 1px solid #374151;
    }

    input[type="file"] {
      margin: 4px 0 8px 0;
      font-size: 13px;
      color: #e5e7eb;
    }

    button {
      margin-top: 4px;
      margin-right: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #3b82f6;
      color: white;
      font-weight: 500;
      font-size: 13px;
    }

    button.secondary {
      background: #374151;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
      min-height: 16px;
    }

    #result {
      margin-top: 12px;
      display: none;
    }

    /* Hints de passo a passo */
    .step-hint {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .step-bullet {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .step-arrow {
      font-size: 12px;
      opacity: 0.9;
    }

    /* Seletor de tipo de fatura (com logo) */
    .tipo-fatura {
      margin-top: 10px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #d1d5db;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    .tipo-fatura span strong {
      font-size: 12px;
      color: #e5e7eb;
    }

    .tipo-option {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease-in-out;
    }

    .tipo-option input[type="radio"] {
      accent-color: #3b82f6;
      cursor: pointer;
    }

    .tipo-option-content {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tipo-option-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
      filter: brightness(1.05);
    }

    .tipo-option span.label {
      font-size: 12px;
    }

    .tipo-option input[type="radio"]:checked + .tipo-option-content .label {
      font-weight: 600;
      color: #bfdbfe;
    }

    /* Layout da área de resultado (agora 2 blocos lado a lado) */
    .result-layout {
      display: flex;
      gap: 16px;
      align-items: stretch;
      margin-top: 8px;
    }

    .main-output {
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .main-output > .step-hint {
      margin-top: 0;
      margin-bottom: 6px;
    }

    /* Painel de sucesso */
    .success-panel {
      position: relative;
      flex: 1 1 auto;
      padding: 16px 16px 18px 16px;
      border-radius: 12px;
      border: 1px solid #374151;
      background: radial-gradient(circle at top left, #1d4ed8 0%, #020617 45%, #020617 100%);
      box-shadow: 0 8px 24px rgba(15,23,42,0.7);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .success-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .success-badge {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle, #22c55e 0%, #15803d 45%, #052e16 100%);
      box-shadow: 0 0 0 0 rgba(34,197,94,0.7);
      animation: pulse 1.8s infinite;
      font-size: 16px;
    }

    .success-title {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .success-sub {
      font-size: 12px;
      color: #cbd5f5;
    }

    .success-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.7); }
      70% { box-shadow: 0 0 0 12px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }

    /* Botão de download — sem emoji, preparado pra imagem */
    .download-button {
      margin-top: 4px;
      margin-right: 0;
      padding: 9px 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.45);
      font-weight: 600;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      text-align: middle;
      min-width: 0;
    }

    .download-icon {
      width: 30px;
      height: 30px;
      object-fit: contain;
      filter: brightness(1.05);
    }

    .download-button:hover {
      filter: brightness(1.15);
      transform: translateY(-1px);
    }

    .download-button:active {
      transform: scale(0.97);
    }

    .download-tip {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* Caixa lateral */
    .side-buttons {
      flex: 0 0 260px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #0b0f19;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 14px;
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.4);
    }

    .side-title {
      font-size: 14px;
      font-weight: 700;
      color: #e5e7eb;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .side-desc {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .side-separator {
      border: 0;
      border-top: 1px dashed #1f2937;
      margin: 8px 0;
    }

    /* Bloco da logo da concessionária */
    .dist-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 10px;
      background: #020617;
      border: 1px dashed #1f2937;
    }

    .dist-logo-wrapper {
      width: 90px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dist-logo {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      filter: brightness(1.05);
    }

    .dist-label {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }

    /* Botões laterais chamativos */
    .side-button {
      position: relative;
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      cursor: pointer;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      transition: all 0.15s ease-in-out;
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.35);
      text-align: center;
    }

    .side-button:hover {
      filter: brightness(1.2);
      transform: translateY(-1px);
    }

    .side-button:active {
      transform: scale(0.96);
    }

    /* Botão do painel com logo do Power BI */
    .panel-button {
      position: relative;
      padding-right: 46px;
      padding-left: 12px;
      background: linear-gradient(90deg, #f2c811, #f59e0b);
      box-shadow: 0 4px 16px rgba(242, 200, 17, 0.45);
      color: #111827;
    }

    .panel-logo {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      object-fit: contain;
      pointer-events: none;
      filter: brightness(1.05);
    }

    /* Tela de loading global */
    #loader {
      position: fixed;
      inset: 0;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
    }

    #loader-logo {
      width: 200px;
      max-width: 60vw;
      margin-bottom: 12px;
    }

    .loader-text {
      color: #e5e7eb;
      font-size: 14px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .loader-bar {
      margin-top: 12px;
      width: 180px;
      max-width: 70vw;
      height: 4px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .loader-bar-inner {
      width: 40%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #1d4ed8, #38bdf8, #22c55e);
      animation: load 1.2s infinite;
    }

    @keyframes load {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(250%); }
    }

    /* Loader local na área do resultado */
    .result-loader {
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      height: 160px;
      border-radius: 6px;
      border: 1px dashed #374151;
      background: #020617;
      margin-top: 8px;
    }

    .result-loader-text {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 8px;
    }

    .result-loader-bar {
      width: 160px;
      max-width: 70%;
      height: 3px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .result-loader-bar-inner {
      width: 45%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #3b82f6, #22c55e, #38bdf8);
      animation: load 1s infinite;
    }
  </style>

  <script>
    // Config pdf.js
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    // Estado global
    let pagesTexts = [];
    let currentTipo = "enel";

    // Config de cada tipo de fatura
    const TIPO_CONFIG = {
      enel: {
        nome: "Enel",
        logo: "https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/enel_logo.png",
        formUrl: "https://forms.office.com/Pages/ResponsePage.aspx?id=h32KRtw5kEm37B9iNhACUjf5h_f9p5hIqNFizEk4SxdUQVAxRFlZQ0g5OVJEOEUxNEpLRENEQ0pNViQlQCN0PWcu&rebef1295d570419382cb678408ce6b56=%22Enel%22"
      },
      equatorial: {
        nome: "Equatorial",
        logo: "https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/equatorial_logo.png",
        formUrl: "https://forms.office.com/SEU_LINK_EQUATORIAL_AQUI"
      },
      outro: {
        nome: "Outro modelo",
        logo: "",
        formUrl: ""
      }
    };

    // Pós-processamento de texto
    function cleanText(text) {
      let t = text;

      if (t.normalize) {
        t = t.normalize("NFC");
      }

      t = t.replace(/[^\x09\x0A\x0D\x20-\x7E\u00A0-\u024F]/g, "");
      t = t.replace(/(\S)\s+([ÁÀÂÃÉÈÊÍÌÎÓÒÔÕÚÙÛÇáàâãéèêíìîóòôõúùûç])/g, "$1$2");
      t = t.replace(/([ÁÀÂÃÉÈÊÍÌÎÓÒÔÕÚÙÛÇáàâãéèêíìîóòôõúùûç])\s+(\S)/g, "$1$2");
      t = t.replace(/([a-záàâãéèêíìîóòôõúùûç])([A-ZÁÀÂÃÉÈÊÍÌÎÓÒÔÕÚÙÛÇ])/g, "$1 $2");
      t = t.replace(/ {2,}/g, " ");

      return t;
    }

    // Extrai texto de cada página
    async function extractTextFromPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;

      let pages = [];

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);

        const rawPageText = strings.join(" ");
        const pageText = cleanText(rawPageText).trim();

        pages.push(pageText);
      }

      return pages;
    }

    // Parser específico ENEL (versão com novos campos)
    function parseEnelFaturas(pages) {
      const resultados = [];

      pages.forEach((txt, idx) => {
        // só páginas que têm o documento auxiliar
        if (!/DOCUMENTO AUXILIAR DA NOTA FISCAL DE ENERGIA ELÉTRICA ELETRÔNICA/i.test(txt)) {
          return;
        }

        // bloco principal: inscrição estadual, número cliente, mês/ano, vencimento, total
        const main = txt.match(
          /INSC\. EST:\s*\d+\s+(\d+)\s+(\d{2}\/\d{4})\s+(\d{2}\/\d{2}\/\d{4})\s+R\$ ?([\d.,]+)/i
        );

        if (!main) {
          return;
        }

        const numCliente = main[1];
        const mesAno     = main[2];
        const vencimento = main[3];
        const total      = main[4];

        // CNPJ
        const cnpjMatch = txt.match(/CPF\/CNPJ:\s*([0-9./-]+)/i);
        const cnpj = cnpjMatch ? cnpjMatch[1].trim() : "";

        // Nota fiscal
        const nfMatch = txt.match(/NOTA FISCAL Nº?\s*([\d]+)/i);
        const notaFiscal = nfMatch ? nfMatch[1] : "";

        // Chave de acesso (juntando os dígitos)
        const chaveMatch = txt.match(/chave de acesso:\s*([\d ]{30,})/i);
        let chaveAcesso = "";
        if (chaveMatch) {
          chaveAcesso = chaveMatch[1].replace(/\s+/g, "");
        }

        // Endereço / Município / UF / CEP (usando a mesma lógica do script antigo)
        let endereco = "";
        let municipio = "";
        let uf = "";
        let cep = "";

        // Trecho entre "MONOFÁSICO" e "CPF/CNPJ:" – igual ao script antigo,
        // aqui sempre vem: NOME DA EMPRESA + ENDEREÇO COMPLETO + CEP + ...
        const clienteBlocoMatch = txt.match(/MONOF[ÁA]SICO\s+(.+?)\s+CPF\/CNPJ:/i);

        if (clienteBlocoMatch) {
          let bloco = clienteBlocoMatch[1]
            .trim()
            .replace(/\s{2,}/g, " ");

          // Se começar com o nome da empresa, remove pra ficar só endereço
          // (ajusta aqui se tiver outras empresas além da Mobit)
          bloco = bloco.replace(/^MOBIT MOBILIDADE ILUM E TEC LTDA\s*/i, "");

          // CEP
          const cepMatch = bloco.match(/CEP:\s*(\d{5}-\d{3})/i);
          if (cepMatch) {
            cep = cepMatch[1];
          }

          // ENDERECO = tudo antes do "CEP:"
          const endMatch = bloco.match(/(.+?)\s+CEP:/i);
          if (endMatch) {
            endereco = endMatch[1].trim();
          } else {
            // fallback: se não achar "CEP:", deixa o bloco todo
            endereco = bloco;
          }

          // MUNICÍPIO + UF = parte final antes do "CEP:"
          // Ex.: "HORIZONTE CENTRO CE CEP: 62882-000"
          const muniUfMatch = bloco.match(/([A-ZÀ-Ú][A-Za-zÀ-ú ]+)\s+([A-Z]{2})\s+CEP:/);
          if (muniUfMatch) {
            municipio = muniUfMatch[1].trim(); // HORIZONTE CENTRO
            uf        = muniUfMatch[2].trim(); // CE
          }
        }


        // Bandeira tarifária
        let bandeiraTarifaria = "";
        const bandMatch = txt.match(/Band\.\s*Tarif\.\s*:\s*([A-Za-zÀ-ú]+)\s*:/i);
        if (bandMatch) {
          bandeiraTarifaria = bandMatch[1].trim();
        }

        // Dados de medição (tabelinha com datas e consumo)
        // Ex.: 23/09/2025 1706.0 23/10/2025 1794.0 1.0 88.0 31
        let dataLeituraAnterior = "";
        let dataLeituraAtual = "";
        let numeroDias = "";
        let consumoKwh = "";

        const leituraMatch = txt.match(
          /(\d{2}\/\d{2}\/\d{4})\s+(\d+\.\d+)\s+(\d{2}\/\d{2}\/\d{4})\s+(\d+\.\d+)\s+(\d+\.\d+)\s+(\d+\.\d+)\s+(\d+)\s*/
        );

        if (leituraMatch) {
          dataLeituraAnterior = leituraMatch[1];
          dataLeituraAtual    = leituraMatch[3];
          consumoKwh          = leituraMatch[6]; // 88.0
          numeroDias          = leituraMatch[7]; // 31
        }

        resultados.push({
          pagina: idx + 1,
          cnpj,
          numCliente,
          endereco,
          municipio,
          uf,
          cep,
          mesAno,
          vencimento,
          total,
          bandeiraTarifaria,
          dataLeituraAnterior,
          dataLeituraAtual,
          numeroDias,
          consumoKwh,
          chaveAcesso,
          notaFiscal,
          textoBruto: txt
        });
      });

      return resultados;
    }

    function hideGlobalLoader() {
      const loader = document.getElementById("loader");
      if (loader) loader.style.display = "none";
    }

    window.addEventListener("load", () => {
      setTimeout(hideGlobalLoader, 5000);
      updateTipoUI();
    });

    function setTipo(tipo) {
      currentTipo = tipo;
      updateTipoUI();
    }

    function updateTipoUI() {
      const cfg = TIPO_CONFIG[currentTipo];
      const distLogo = document.getElementById("distLogo");
      const distLabel = document.getElementById("distLabel");
      const registerBtn = document.getElementById("registerButton");
      const tipoNomeSpan = document.getElementById("tipoNomeSpan");

      if (cfg.logo) {
        distLogo.src = cfg.logo;
        distLogo.style.opacity = "1";
      } else {
        distLogo.src = "";
        distLogo.style.opacity = "0.2";
      }

      distLabel.textContent = cfg.nome
        ? `Tipo selecionado: ${cfg.nome}`
        : "Selecione o tipo de fatura acima.";

      if (tipoNomeSpan) {
        tipoNomeSpan.textContent = cfg.nome || "—";
      }

      if (cfg.formUrl) {
        registerBtn.disabled = false;
        registerBtn.textContent = `Registrar fatura (${cfg.nome})`;
      } else {
        registerBtn.disabled = true;
        registerBtn.textContent = "Registrar fatura (tipo sem formulário)";
      }
    }

    async function handleFileChange() {
      const fileInput     = document.getElementById("pdfFile");
      const status        = document.getElementById("status");
      const button        = document.getElementById("convertButton");
      const resultDiv     = document.getElementById("result");
      const resultLoader  = document.getElementById("resultLoader");
      const resultInner   = document.getElementById("resultInner");
      const pageCountSpan = document.getElementById("pageCountSpan");

      const file = fileInput.files[0];
      if (!file) {
        alert("Escolha um PDF primeiro.");
        return;
      }

      if (file.type !== "application/pdf") {
        alert("Selecione um arquivo PDF (.pdf).");
        return;
      }

      pagesTexts = [];
      resultDiv.style.display = "block";
      resultLoader.style.display = "flex";
      resultInner.style.display  = "none";
      status.textContent = "Lendo PDF, aguarde...";
      button.disabled = true;

      try {
        const pages = await extractTextFromPDF(file);
        pagesTexts = pages;

        if (pageCountSpan) {
          pageCountSpan.textContent = pagesTexts.length;
        }

        status.textContent = "Pronto! PDF lido com sucesso.";
        resultLoader.style.display = "none";
        resultInner.style.display  = "block";
      } catch (err) {
        console.error(err);
        status.textContent = "Erro ao ler o PDF. Veja o console para detalhes.";
        alert("Deu erro ao ler o PDF.");
        resultLoader.style.display = "none";
        resultInner.style.display  = "none";
        resultDiv.style.display    = "none";
      } finally {
        button.disabled = false;
      }
    }

    // Gera XLSX conforme o tipo atual
    async function downloadXlsx() {
      const status = document.getElementById("status");

      if (!pagesTexts || pagesTexts.length === 0) {
        alert("Nenhum texto de página encontrado. Converta o PDF primeiro.");
        return;
      }

      try {
        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet("FATURAS");

        if (currentTipo === "enel") {
          const faturas = parseEnelFaturas(pagesTexts);

          if (faturas.length === 0) {
            alert("Nenhuma fatura ENEL padrão encontrada no texto.");
            return;
          }

          const rows = faturas.map(f => [
            f.pagina,
            f.cnpj,
            f.numCliente,
            f.endereco,
            f.municipio,
            f.uf,
            f.cep,
            f.mesAno,
            f.vencimento,
            f.total,
            f.bandeiraTarifaria,
            f.dataLeituraAnterior,
            f.dataLeituraAtual,
            f.numeroDias,
            f.consumoKwh,
            f.chaveAcesso,
            f.notaFiscal,
            f.textoBruto
          ]);

          sheet.addTable({
            name: "FATURAS",
            ref: "A1",
            headerRow: true,
            totalsRow: false,
            style: {
              theme: "TableStyleMedium2",
              showRowStripes: true
            },
            columns: [
              { name: "PAGINA",              filterButton: true },
              { name: "CNPJ",                filterButton: true },
              { name: "NUM_CLIENTE",         filterButton: true },
              { name: "ENDERECO",            filterButton: true },
              { name: "MUNICIPIO",           filterButton: true },
              { name: "UF",                  filterButton: true },
              { name: "CEP",                 filterButton: true },
              { name: "MES_ANO",             filterButton: true },
              { name: "VENCIMENTO",          filterButton: true },
              { name: "TOTAL",               filterButton: true },
              { name: "BANDEIRA_TARIFARIA",  filterButton: true },
              { name: "DT_LEIT_ANTERIOR",    filterButton: true },
              { name: "DT_LEIT_ATUAL",       filterButton: true },
              { name: "NUM_DIAS",            filterButton: true },
              { name: "CONSUMO_KWH",         filterButton: true },
              { name: "CHAVE_ACESSO",        filterButton: true },
              { name: "NOTA_FISCAL",         filterButton: true },
              { name: "TEXTO_BRUTO",         filterButton: false }
            ],
            rows: rows
          });

          sheet.getColumn(1).width  = 8;   // pagina
          sheet.getColumn(2).width  = 22;  // cnpj
          sheet.getColumn(3).width  = 14;  // num cliente
          sheet.getColumn(4).width  = 45;  // endereco
          sheet.getColumn(5).width  = 20;  // municipio
          sheet.getColumn(6).width  = 6;   // uf
          sheet.getColumn(7).width  = 12;  // cep
          sheet.getColumn(8).width  = 10;  // mes/ano
          sheet.getColumn(9).width  = 12;  // vencimento
          sheet.getColumn(10).width = 14;  // total
          sheet.getColumn(11).width = 16;  // bandeira
          sheet.getColumn(12).width = 14;  // dt leit ant
          sheet.getColumn(13).width = 14;  // dt leit atual
          sheet.getColumn(14).width = 10;  // dias
          sheet.getColumn(15).width = 14;  // consumo
          sheet.getColumn(16).width = 32;  // chave
          sheet.getColumn(17).width = 14;  // nf
          sheet.getColumn(18).width = 120; // texto bruto

        } else {
          // Genérico para Equatorial / Outros: página + texto bruto
          const rows = pagesTexts.map((txt, idx) => [idx + 1, txt]);

          sheet.addTable({
            name: "FATURAS",
            ref: "A1",
            headerRow: true,
            totalsRow: false,
            style: {
              theme: "TableStyleMedium9",
              showRowStripes: true
            },
            columns: [
              { name: "PAGINA",      filterButton: true },
              { name: "TEXTO_BRUTO", filterButton: false }
            ],
            rows: rows
          });

          sheet.getColumn(1).width = 8;
          sheet.getColumn(2).width = 120;
        }

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob(
          [buffer],
          { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }
        );

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = currentTipo === "enel"
          ? "FATURAS_ENEL.xlsx"
          : "FATURAS.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        status.textContent = "Arquivo Excel gerado com sucesso.";
      } catch (e) {
        console.error(e);
        alert("Erro ao gerar o arquivo Excel.");
        status.textContent = "Erro ao gerar o arquivo Excel.";
      }
    }

    function openFormAtual() {
      const cfg = TIPO_CONFIG[currentTipo];
      if (!cfg.formUrl) {
        alert("Formulário não configurado para este tipo de fatura.");
        return;
      }
      window.open(cfg.formUrl, "_blank");
    }

    function openPainel() {
      const url = "https://app.powerbi.com/SEU_LINK_PAINEL_AQUI";

      if (url.indexOf("SEU_LINK_PAINEL_AQUI") !== -1) {
        alert("URL do Painel de Acompanhamento ainda não configurada.");
        return;
      }

      window.open(url, "_blank");
    }
  </script>
</head>
<body>
  <!-- Loader global -->
  <div id="loader">
    <img
      id="loader-logo"
      src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo.png"
      alt="Logo"
    >
    <div class="loader-text">Carregando Processamento de Faturas de Energia...</div>
    <div class="loader-bar">
      <div class="loader-bar-inner"></div>
    </div>
  </div>

  <!-- HEADER FORA DO CARD -->
  <div class="top-header">
    <div class="header-logo-container">
      <img
        class="header-logo"
        src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/logo.png"
        alt="Logo do Setor"
      />
    </div>

    <div class="support-info">
      <span><strong>Suporte:</strong> Nome do responsável</span>
      <span>email@mobit.com.br</span>
      <span>(XX) XXXXX-XXXX</span>
    </div>
  </div>

  <div class="card">
    <h1>PROCESSAMENTO DE FATURAS DE ENERGIA - MOBIT</h1>
    <p>Escolha a concessionária, selecione o PDF e gere o arquivo Excel.</p>

    <!-- Seletor de tipo de fatura -->
    <div class="tipo-fatura">
      <span><strong>Tipo de fatura:</strong></span>

      <label class="tipo-option">
        <input type="radio" name="tipoFatura" value="enel" checked onclick="setTipo('enel')">
        <span class="tipo-option-content">
          <img
            src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/enel_logo.png"
            alt="Enel"
            class="tipo-option-logo"
          >
        </span>
      </label>

      <label class="tipo-option">
        <input type="radio" name="tipoFatura" value="equatorial" onclick="setTipo('equatorial')">
        <span class="tipo-option-content">
          <img
            src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/equatorial_logo.png"
            alt="Equatorial"
            class="tipo-option-logo"
          >
        </span>
      </label>

    </div>

    <!-- Passo 1: escolher o arquivo -->
    <div class="step-hint">
      <div class="step-bullet">1</div>
      <span><span class="step-arrow">➜</span> Escolha o arquivo PDF da fatura.</span>
    </div>

    <input type="file" id="pdfFile" accept="application/pdf" />

    <!-- Passo 2: converter -->
    <div class="step-hint">
      <div class="step-bullet">2</div>
      <span><span class="step-arrow">➜</span> Clique em <strong>"Converter PDF para texto"</strong>.</span>
    </div>

    <button id="convertButton" onclick="handleFileChange()">Converter PDF para texto</button>

    <div id="status" class="status"></div>

    <div id="result">
      <!-- Loader local -->
      <div id="resultLoader" class="result-loader">
        <div class="result-loader-text">Convertendo PDF para texto...</div>
        <div class="result-loader-bar">
          <div class="result-loader-bar-inner"></div>
        </div>
      </div>

      <!-- Conteúdo final -->
      <div id="resultInner" style="display:none;">
        <div class="result-layout">
          <!-- Painel principal -->
          <div class="main-output">
            <div class="step-hint">
              <div class="step-bullet">3</div>
              <span>
                <span class="step-arrow">➜</span>
                Baixe o Excel com para o tipo selecionado.
              </span>
            </div>

            <div class="success-panel">
              <div class="success-header">
                <div class="success-badge">✓</div>
                <div>
                  <div class="success-title">PDF processado com sucesso</div>
                  <div class="success-sub">
                    <span id="pageCountSpan">0</span> página(s) detectadas •
                    Tipo: <span id="tipoNomeSpan">Enel</span>
                  </div>
                </div>
              </div>

              <div class="success-meta">
                Gere um arquivo Excel pronto para registrar no Form ao lado, com isso o arquivo será processado no Power Automate para Power BI estruturada
                de acordo com a concessionária selecionada.
              </div>

              <button class="download-button" type="button" onclick="downloadXlsx()">
                <!-- troca esse src pela imagem que quiser -->
                <img
                  id="downloadIcon"
                  class="download-icon"
                  src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/output-onlinepngtools.png"
                  alt="Download"
                >
                <span>Baixar Excel</span>
              </button>
            </div>
          </div>

          <!-- Bloco lateral -->
          <div class="side-buttons">
            <div class="side-title">Registrar fatura</div>
            <div class="side-desc">
              Após gerar o Excel ou ler os dados, use o botão abaixo para abrir o formulário da concessionária.
            </div>

            <div class="dist-block">
              <div class="dist-logo-wrapper">
                <img
                  id="distLogo"
                  class="dist-logo"
                  src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/enel_logo.png"
                  alt="Logo da concessionária"
                />
              </div>
              <div id="distLabel" class="dist-label">
                Tipo selecionado: Enel
              </div>
            </div>

            <button
              id="registerButton"
              type="button"
              class="side-button"
              onclick="openFormAtual()"
            >
              Registrar fatura (Enel)
            </button>

            <hr class="side-separator" />

            <div class="side-title" style="font-size: 13px; margin-bottom: 4px;">
              Painel de acompanhamento
            </div>
            <div class="side-desc">
              Consulte o histórico das faturas registradas.
            </div>

            <button
              type="button"
              class="side-button panel-button"
              onclick="openPainel()"
            >
              Abrir Painel de Acompanhamento
              <img
                class="panel-logo"
                src="https://raw.githubusercontent.com/BImobit/BI/refs/heads/main/TI/IMAGENS/power_bi.png"
                alt="Power BI"
              />
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
